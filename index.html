<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø·Ø¹Ù… ØµÙ…Ù‘Ø§Ù…</title>
  <link rel="stylesheet" href="style.css" />
  <style>
      /* --- ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ --- */
      .hidden { display: none !important; }

      /* --- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠ --- */
      #announcement-bar {
          background-color: #fef3c7;
          color: #92400e;
          font-weight: bold;
          padding: 12px 0;
          display: none; /* ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          z-index: 2000;
          text-align: center;
          justify-content: center;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .marquee-container {
          width: 100%;
          overflow: hidden;
          white-space: nowrap;
      }
      .marquee {
          display: inline-block;
          padding-left: 100%;
          animation: marquee 20s linear infinite;
      }
      @keyframes marquee {
          0% { transform: translate(0, 0); }
          100% { transform: translate(100%, 0); }
      }

      /* --- Ø´Ø§Ø±Ø© Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… --- */
      .discount-badge {
          position: absolute;
          top: 10px;
          right: 10px;
          background-color: #dc2626; /* Ø£Ø­Ù…Ø± */
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: bold;
          z-index: 10;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .old-price {
          text-decoration: line-through;
          color: #9ca3af;
          font-size: 0.9em;
          margin-left: 5px;
      }

      /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- */
      .menu-item-type, .menu-item-rice { margin: 10px 0; }
      .menu-item-type label, .menu-item-rice label {
          display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555;
      }
      .custom-select {
          width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
          background: #f9f9f9; font-family: inherit; font-size: 14px; color: #333;
      }
      .custom-select:focus { outline: none; border-color: #e65100; }
      
      button.add-to-cart:disabled { background-color: #ccc !important; cursor: not-allowed; opacity: 0.6; }
      
      /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- */
      .cart-input {
          width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd;
          border-radius: 5px; font-family: inherit; font-size: 14px;
      }
      .cart-section-title {
          font-weight: bold; margin: 15px 0 10px; font-size: 14px; color: #e65100;
          border-bottom: 1px solid #eee; padding-bottom: 5px;
      }
      .dynamic-fields {
          background: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 10px;
          border: 1px solid #eee;
      }
      
      img[src=""] { display: none; }

      /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) --- */
      .track-modal-overlay, .profile-modal-overlay, .rating-modal-overlay {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5); z-index: 3000;
          display: none; align-items: center; justify-content: center;
          backdrop-filter: blur(5px);
      }
      .track-modal, .profile-modal, .rating-modal {
          background: white; width: 90%; max-width: 450px;
          border-radius: 20px; padding: 25px;
          box-shadow: 0 20px 50px rgba(0,0,0,0.3);
          position: relative;
          max-height: 85vh; overflow-y: auto;
          border: 1px solid rgba(255,255,255,0.8);
          text-align: center;
      }
      .track-modal h3, .profile-modal h3, .rating-modal h3 { 
          margin-top: 0; color: #333; text-align: center; margin-bottom: 20px; 
          font-family: 'Cairo', sans-serif; font-weight: 700;
      }
      .track-close {
          position: absolute; top: 15px; left: 15px;
          font-size: 24px; cursor: pointer; color: #999; transition: 0.3s;
      }
      .track-close:hover { color: #d84315; }

      .order-status-card {
          border: 1px solid #f0f0f0; border-radius: 12px; padding: 15px; margin-bottom: 12px;
          background: #fff; transition: 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      }
      .order-status-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); transform: translateY(-2px); }
      .status-badge {
          display: inline-block; padding: 5px 12px; border-radius: 20px;
          font-size: 11px; font-weight: bold; margin-bottom: 8px;
      }
      .status-Ø¬Ø¯ÙŠØ¯ { background: #e0f2fe; color: #0369a1; }
      .status-Ø¬Ø§Ø±ÙŠ-Ø§Ù„ØªØ­Ø¶ÙŠØ± { background: #fef3c7; color: #b45309; }
      .status-Ù…ÙƒØªÙ…Ù„ { background: #dcfce7; color: #15803d; }
      
      .track-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
      .track-btn { background: #e65100; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
      .track-btn:hover { background: #bf360c; }

      /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø§Ù„Ù†Ø¬ÙˆÙ…) --- */
      .star-rating {
          display: flex;
          flex-direction: row-reverse;
          justify-content: center;
          gap: 10px;
          margin: 20px 0;
      }
      .star-rating input { display: none; }
      .star-rating label {
          font-size: 30px;
          color: #ddd;
          cursor: pointer;
          transition: color 0.2s;
      }
      .star-rating input:checked ~ label,
      .star-rating label:hover,
      .star-rating label:hover ~ label {
          color: #ffc107;
      }
      .rating-textarea {
          width: 100%;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 10px;
          resize: none;
          height: 80px;
          margin-bottom: 15px;
          font-family: inherit;
      }
      .submit-rating-btn {
          background: #d21d40;
          color: white;
          border: none;
          padding: 10px 25px;
          border-radius: 20px;
          font-weight: bold;
          cursor: pointer;
          width: 100%;
          margin-bottom: 10px;
      }
      .google-map-btn {
          background: #fff;
          color: #4285F4;
          border: 1px solid #4285F4;
          padding: 10px 25px;
          border-radius: 20px;
          font-weight: bold;
          cursor: pointer;
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          text-decoration: none;
          margin-top: 10px;
      }
      .google-map-btn:hover { background: #f0f8ff; }

      /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù…Ø­Ø³Ù†Ø©) --- */
      .header-left-group {
          display: flex;
          align-items: center;
          gap: 15px;
          margin-right: auto;
      }
      .header-user-btn {
          display: flex;
          align-items: center;
          gap: 10px;
          background: white;
          border: 1px solid #eee;
          padding: 6px 15px;
          border-radius: 25px;
          cursor: pointer;
          transition: all 0.3s ease;
          color: #444;
          font-family: inherit;
          font-weight: 700;
          font-size: 14px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .header-user-btn:hover {
          background: #fff8e1;
          border-color: #ffb300;
          color: #e65100;
          box-shadow: 0 4px 10px rgba(255, 179, 0, 0.2);
          transform: translateY(-1px);
      }
      
      /* --- ØªØ¹Ø¯ÙŠÙ„: Ø³ØªØ§ÙŠÙ„ Ø²Ø± Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ --- */
      .header-user-btn.visitor-mode {
          width: 42px;
          height: 42px;
          padding: 0;
          border-radius: 50%;
          justify-content: center;
      }
      .header-user-btn.visitor-mode span:not(.header-user-icon) {
          display: none;
      }

      /* ğŸ”¥ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØµÙˆØ±Ø© ÙÙ‚Ø· - Ø¯Ø§Ø¦Ø±ÙŠ) ğŸ”¥ */
      .header-user-btn.logged-in-style {
          background: #fff;
          color: #e65100;
          border-radius: 50%;
          width: 45px;
          height: 45px;
          padding: 0;
          justify-content: center;
          border-color: #fff;
          overflow: hidden; /* Ù„Ø¶Ù…Ø§Ù† Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø© */
      }
      
      .header-user-avatar {
          width: 100%;
          height: 100%;
          border-radius: 50%;
          object-fit: cover;
          border: none;
          box-shadow: none;
      }

      .header-user-icon {
          font-size: 18px;
          color: #ff9800; /* Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
      }

      /* Dropdown Menu for User */
      .user-dropdown {
          position: absolute;
          top: 65px;
          left: 10px; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø± */
          background: white;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.15);
          width: 200px;
          display: none;
          z-index: 2500;
          overflow: hidden;
          border: 1px solid #f0f0f0;
          animation: slideDown 0.2s ease-out;
      }
      @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
      .user-dropdown.show { display: block; }
      .user-dropdown-item {
          padding: 12px 20px;
          border-bottom: 1px solid #f8f8f8;
          cursor: pointer;
          font-size: 14px;
          transition: background 0.2s;
          display: flex;
          align-items: center;
          gap: 10px;
          color: #555;
      }
      .user-dropdown-item:hover { background: #fff8e1; color: #e65100; }
      .user-dropdown-item:last-child { border-bottom: none; color: #d32f2f; }
      /* Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø£Ù† ÙŠÙƒÙˆÙ† Ø²Ø± Ø¬ÙˆØ¬Ù„ Ø£Ùˆ Ø§Ù„Ø²Ø§Ø¦Ø± Ø£Ø­Ù…Ø± */
      .user-dropdown-item.logout-item { color: #d32f2f; }
      .user-dropdown-item.logout-item:hover { background: #ffebee; color: #b71c1c; }

      /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ --- */
      .profile-info { text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
      .profile-avatar-large { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #e65100; margin-bottom: 10px; }
      .profile-name-large { font-size: 18px; font-weight: bold; color: #333; }
      .profile-email { font-size: 13px; color: #777; }
      .order-date { font-size: 12px; color: #888; display: block; margin-top: 5px; }

      /* === ğŸ”¥ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”¥ === */
      @media (max-width: 768px) {
          /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Øµ ÙÙŠ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
          .header-user-btn span:not(.header-user-icon) {
              display: none;
          }
          /* ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø¯Ø§Ø¦Ø±Ø© ØµØºÙŠØ±Ø© */
          .header-user-btn {
              padding: 8px;
              border-radius: 50%;
              width: 40px;
              height: 40px;
              justify-content: center;
          }
          .header-user-avatar {
              margin: 0; /* ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø© */
          }
          /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª */
          .header-left-group {
              gap: 8px;
          }
          .cart-container {
              margin-right: 5px;
          }
          /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
          .user-dropdown {
              width: 180px;
              left: 5px;
          }
      }
  </style>
</head>
<body>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
<div id="announcement-bar">
    <div class="marquee-container">
        <div class="marquee" id="announcement-text">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…Ø·Ø¹Ù… ØµÙ…Ù‘Ø§Ù…</div>
    </div>
</div>

<div class="header-bg" id="headerBg"></div>
<header class="main-header">
  <div class="header-container">
      <div class="header-title">
         <img src="images/SAMAM HEADER.png" alt="Samam Logo" class="logo-img" onerror="this.style.display='none'" />
      </div>

      <!-- Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
      <div class="menu-toggle" id="menuToggle">â˜°</div>

      <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
      <nav class="mobile-menu" id="mobileMenu">
        <ul>
          <li><a href="#" onclick="window.scrollTo(0,0); return false;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
          <li><a href="#" id="openTrackModalBtn" style="color: #fdf2d4; font-weight: bold;">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ ğŸšš</a></li>
          <li><a href="#" id="toggleAboutBtn">Ù…Ù† Ù†Ø­Ù†</a></li>
          <li><a href="#menu">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</a></li>
          <li><a href="#contact-footer">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a></li>
        </ul>
      </nav>

      <!-- Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙŠØ³Ø§Ø± (Ø³Ù„Ø© + Ù…Ø³ØªØ®Ø¯Ù…) -->
      <div class="header-left-group">
          
          <!-- Ø²Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠØ³Ø§Ø± Ø§Ù„Ø³Ù„Ø©) -->
          <div id="headerUserContainer" style="position: relative;">
              <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø¢Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø­Ø§Ù„ØªÙŠÙ† (Ø²Ø§Ø¦Ø± Ø£Ùˆ Ù…Ø³Ø¬Ù„) -->
              <button id="headerUserBtn" class="header-user-btn visitor-mode" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„">
                  <span class="header-user-icon">ğŸ‘¤</span>
                  <!-- Ø§Ù„Ù†Øµ Ù…Ø®ÙÙŠ Ø¨Ø§Ù„Ù€ CSS -->
                  <span>Ø¯Ø®ÙˆÙ„</span>
              </button>
              <div id="userDropdown" class="user-dropdown">
                  <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨ÙˆØ§Ø³Ø·Ø© JS Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© -->
              </div>
          </div>

          <div class="cart-container">
            <img src="https://cdn-icons-png.flaticon.com/512/833/833314.png" alt="Ø§Ù„Ø³Ù„Ø©" class="cart-icon" />
            <span class="cart-count">0</span>
          </div>

      </div>

  </div>
</header>

<section class="hero-section">
  <img src="images/hero 1.jpg (2).jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø·Ø¹Ù…" class="hero-img" id="hero-img-element" onerror="this.src='https://via.placeholder.com/1500x800?text=Samam'">
  <div class="hero-overlay"></div>
  <div class="hero-logo">
    <img src="images/logo p.png" alt="Ù„ÙˆØ¬Ùˆ ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø©" onerror="this.style.display='none'">
  </div>

  <div class="hero-content">
    <h1 class="hero-title" id="hero-title-text">Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€ Ù…Ø¶ØºÙˆØ· ÙˆØ§ÙƒØ«Ø±</h1>
    <a href="#menu" class="menu-btn">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</a>
  </div>

  <div class="hero-services">
    <p>
      Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¹Ø§Ø´Ø© ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª<br>
      ( Ø´Ø±ÙƒØ§Øª - Ø¬Ù…Ø¹ÙŠØ§Øª - Ø¥ÙØ·Ø§Ø± ØµØ§Ø¦Ù… )
    </p>
    <a href="https://wa.me/966592372549" target="_blank">
      Ø§Ø¶ØºØ· Ù‡Ù†Ø§
    </a>
  </div>
</section>

<!-- Ù‚Ø³Ù… Ù…Ù† Ù†Ø­Ù† -->
<section class="about-section hidden" id="about">
  <h2 class="about-title">Ù…Ù† Ù†Ø­Ù†</h2>
  <div class="about-boxes">
    <div class="about-box">
      <h3> ØµÙ…Ù‘Ø§Ù…</h3>
      <p>Ø¹Ù„Ø§Ù…Ø© ØªØ¬Ø§Ø±ÙŠØ© ØªØ£Ø³Ø³Øª ÙÙŠ Ø¹Ø§Ù… 2024ØŒ Ø¨Ø®Ø¨Ø±Ø© ØªØ³Ø¨Ù‚ Ø³Ù†Ø© Ø§Ù„ØªØ£Ø³ÙŠØ³ Ø¨Ø£Ø¹ÙˆØ§Ù… Ø¹Ø¯ÙŠØ¯Ø© ÙˆØ´ØºÙ ÙƒØ¨ÙŠØ±. Ù‚ÙØ¯ÙÙ…Ù†Ø§ Ø¨ÙÙƒØ±Ø© Ù†Ø¹ÙŠØ¯ ÙÙŠÙ‡Ø§ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£ÙƒÙ„Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ ÙˆÙ†Ù‚Ø¯Ù‘Ù…Ù‡Ø§ Ø¨Ø±ÙˆØ­ Ø¬Ø¯ÙŠØ¯Ø© ØªÙØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµØ§Ù„Ø©â€¦ ÙˆÙ„ÙƒÙ† Ø¨Ù„Ù…Ø³Ø© ØµÙ…Ù‘Ø§Ù… Ø§Ù„Ø®Ø§ØµØ©.</p>
    </div>
    <div class="about-box">
      <h3>Ù‡Ø¯ÙÙ†Ø§</h3>
      <p>Ù†ÙØ­Ø³Ù‘Ù† Ø§Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¹Ù† Ø§Ù„Ù†ÙƒÙ‡Ø§ØªØŒ ÙˆÙ†Ù‚Ø¯Ù… Ø£Ø·Ø¨Ø§Ù‚Ù†Ø§ Ø¨Ø´ÙƒÙ„ Ù„Ø§Ø¦Ù‚ ÙˆÙŠØ¹Ø¨Ù‘Ø± Ø¹Ù† Ø¬ÙˆØ¯ØªÙ†Ø§.</p>
    </div>
    <div class="about-box">
      <h3>Ø±Ø¤ÙŠØªÙ†Ø§</h3>
      <p>Ù†ÙØµØ¨Ø­ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆÙ†ÙƒÙÙˆÙ† Ø¨ØµÙ…Ø© ØªÙÙ…ÙŠÙØ² ØªØ¹ÙƒØ³ Ø§Ù„Ù‡ÙˆÙŠØ© ÙÙŠ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø­Ø¯ÙŠØ«Ø©.</p>
    </div>
    <div class="about-box">
      <h3>ÙˆØ´ ÙŠÙ…ÙŠØ²Ù†Ø§</h3>
      <p>ÙˆØµÙØ§Øª Ù…Ø·ÙˆØ±Ø© Ø¨Ù†ÙƒÙ‡Ø§ØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ©ØŒ Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆØ·Ø¹Ù… ÙŠØ±Ø³Ø® Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©ØŒ Ø£ØµÙ†Ø§Ù ØªØ°ÙƒØ±Ùƒ Ø¨Ø§Ù„Ù…Ø§Ø¶ÙŠâ€¦ Ø¨Ø³ Ø¨Ø·Ø±ÙŠÙ‚ØªÙ†Ø§.</p>
    </div>
  </div>
</section>

<!-- Ù‚Ø³Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù… -->
<section id="menu" class="menu-section">
  <h2 class="section-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</h2>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
  <div class="category-buttons">
    <button class="category-btn active" data-category="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
    <button class="category-btn" data-category="chicken">Ø¯Ø¬Ø§Ø¬</button>
    <button class="category-btn" data-category="meat">Ù„Ø­Ù…</button>
    <button class="category-btn" data-category="rice">Ø±Ø²</button>
    <button class="category-btn" data-category="sides">Ø·Ù„Ø¨Ø§Øª Ø¬Ø§Ù†Ø¨ÙŠØ©</button>
    <button class="category-btn" data-category="drinks">Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</button>
  </div>

  <!-- Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
  <div class="menu-items">
    <div id="chicken" class="menu-group"></div>
    <div id="meat" class="menu-group"></div>
    <div id="rice" class="menu-group"></div>
    <div id="sides" class="menu-group"></div>
    <div id="drinks" class="menu-group"></div>
    
    <div id="loading-msg" style="text-align: center; width: 100%; padding: 40px; color: #666; font-size: 1.2em;">
      <span style="display:inline-block; animation: spin 1s linear infinite">â³</span> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...
    </div>
  </div>
</section>

<!-- Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
<div class="cartSlider" id="cartSlider_v2">
  <div class="cartSlider-header">
    <h3>Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
    <span class="cartSlider-close" id="closeCart_v2">&times;</span>
  </div>

  <div class="cartSlider-items" id="cartItems_v2">
    <p class="empty-cart">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§</p>
  </div>

  <div class="cartSlider-options" style="padding: 0 15px;">
    <div class="cart-section-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø·Ù„ÙˆØ¨Ø©)</div>
    <input type="text" id="customerName" class="cart-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ±ÙŠÙ…" required>
    <input type="tel" id="customerPhone" class="cart-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (05xxxxxxxx)" required>

    <div class="cart-section-title">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø¨</div>
    <label style="font-size:12px; font-weight:bold;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
    <select id="deliveryMethod_v2" class="cart-input">
      <option value="Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙØ±Ø¹">Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙØ±Ø¹</option>
      <option value="ØªÙˆØµÙŠÙ„">ØªÙˆØµÙŠÙ„ (Ø±Ø³ÙˆÙ… 15 Ø±.Ø³)</option>
      <option value="ØªØ³Ù„ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©">ØªØ³Ù„ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
    </select>

    <div id="deliveryFields" class="dynamic-fields" style="display:none;">
      <label style="font-size:12px; font-weight:bold;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„:</label>
      <input type="text" id="addressDetail" class="cart-input" placeholder="Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„">
      <label style="font-size:12px; font-weight:bold;">Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©:</label>
      <input type="text" id="landmark" class="cart-input" placeholder="Ø¨Ø¬ÙˆØ§Ø± Ù…Ø³Ø¬Ø¯/Ù…Ø¯Ø±Ø³Ø©...">
    </div>

    <div id="carFields" class="dynamic-fields" style="display:none;">
      <label style="font-size:12px; font-weight:bold;">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</label>
      <input type="text" id="carType" class="cart-input" placeholder="Ù…Ø«Ø§Ù„: ØªÙˆÙŠÙˆØªØ§ ÙƒØ§Ù…Ø±ÙŠ">
      <label style="font-size:12px; font-weight:bold;">Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</label>
      <input type="text" id="carPlate" class="cart-input" placeholder="Ù…Ø«Ø§Ù„: Ø£ Ø¨ Ø¬ 1234">
    </div>

    <label style="font-size:12px; font-weight:bold;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
    <select id="paymentMethod_v2" class="cart-input">
      <option value="ÙƒØ§Ø´">ÙƒØ§Ø´ (Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…)</option>
      <option value="Ø´Ø¨ÙƒØ©">Ø´Ø¨ÙƒØ© (Ù…Ø¯Ù‰/ÙÙŠØ²Ø§)</option>
    </select>
  </div>

  <div class="cartSlider-discount">
    <label>ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (ÙŠØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„):</label>
    <div style="display:flex; gap:5px;">
        <input type="text" id="discountCode_v2" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯" style="flex:1;">
        <button id="applyDiscountBtn_v2">ØªØ·Ø¨ÙŠÙ‚</button>
    </div>
    <p id="discountMessage_v2" style="margin-top: 5px; font-size: 0.9em;"></p>
  </div>

  <div class="cartSlider-total" id="cartTotal_v2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0 Ø±ÙŠØ§Ù„</div>

  <button class="cartSlider-send" id="sendOrder_v2">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ (Modal) -->
<div class="track-modal-overlay" id="trackModalOverlay">
    <div class="track-modal">
        <span class="track-close" id="closeTrackModal">&times;</span>
        <h3>ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ</h3>
        <p style="text-align:center; color:#666; font-size:14px; margin-bottom:15px;">Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø°ÙŠ Ù‚Ù…Øª Ø¨Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù‡</p>
        
        <div class="track-input-group">
            <input type="tel" id="trackPhoneInput" class="cart-input" placeholder="05xxxxxxxx" style="margin-bottom:0;">
            <button id="searchOrderBtn" class="track-btn">Ø¨Ø­Ø«</button>
        </div>

        <div id="trackResults">
            <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‡Ù†Ø§ -->
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Profile Modal) -->
<div class="profile-modal-overlay" id="profileModalOverlay">
    <div class="profile-modal">
        <span class="track-close" id="closeProfileModal">&times;</span>
        <h3>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
        <div id="profileContent">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
            <div style="text-align:center; color:#666;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">
        <h4 style="margin-bottom:15px; color:#e65100;">Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
        <div id="userOrdersList">
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Rating Modal) -->
<div class="rating-modal-overlay" id="ratingModalOverlay">
    <div class="rating-modal">
        <h3>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ! ÙƒÙŠÙ ÙƒØ§Ù†Øª ØªØ¬Ø±Ø¨ØªÙƒØŸ ğŸŒŸ</h3>
        <div class="star-rating">
            <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 Ù†Ø¬ÙˆÙ…">â˜…</label>
            <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 Ù†Ø¬ÙˆÙ…">â˜…</label>
            <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 Ù†Ø¬ÙˆÙ…">â˜…</label>
            <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 Ù†Ø¬ÙˆÙ…">â˜…</label>
            <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="Ù†Ø¬Ù…Ø© ÙˆØ§Ø­Ø¯Ø©">â˜…</label>
        </div>
        <textarea id="ratingComment" class="rating-textarea" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..."></textarea>
        <button id="submitRatingBtn" class="submit-rating-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
        <button id="closeRatingModal" style="background:transparent; color:#666; border:none; margin-top:10px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
        
        <div id="googleMapLinkContainer" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <p style="font-size:14px; color:#555;">Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ùƒ! Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ø¹Ù…Ù†Ø§ Ø¨ØªÙ‚ÙŠÙŠÙ… Ø¹Ù„Ù‰ Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨ØŸ</p>
            <a href="https://www.google.com/maps/place/%D8%B5%D9%85%D9%91%D8%A7%D9%85+%7C+SAMAM%E2%80%AD/@21.4794463,39.3315865,17z/data=!3m1!4b1!4m6!3m5!1s0x15c233003dffe0a5:0x3e53f78849ed6cf6!8m2!3d21.4794463!4d39.3315865!16s%2Fg%2F11yrtyzfnf?entry=ttu&g_ep=EgoyMDI2MDIwOS4wIKXMDSoASAFQAw%3D%3D" target="_blank" class="google-map-btn">
                <img src="https://upload.wikimedia.org/wikipedia/commons/a/aa/Google_Maps_icon_%282020%29.svg" width="20" alt="Google Maps">
                ØªÙ‚ÙŠÙŠÙ… Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„
            </a>
        </div>
    </div>
</div>

<footer class="site-footer" id="contact-footer">
  <div class="footer-container">
    <div class="footer-brand">
      <div class="logo-wrapper">
        <img src="images/logo red.png" alt="Ø´Ø¹Ø§Ø± Ù…Ø·Ø¹Ù… ØµÙ…Ù‘Ø§Ù…" class="restaurant-logo" onerror="this.style.display='none'">
      </div>
      <h3>Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€ Ù…Ø¶ØºÙˆØ· ÙˆØ§ÙƒØ«Ø±</h3>
      <p class="restaurant-address">Ø¬Ø¯Ø© - Ø´Ø§Ø±Ø¹ Ø§Ù„Ø­Ø±Ø§Ø²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</p>
    </div>

    <div class="footer-social-section">
      <h4 class="section-title">ÙƒÙŠÙ ØªÙˆØµÙ„Ù†Ø§</h4>
      <div class="footer-social">
        <a href="https://wa.me/966539490701" target="_blank" title="ÙˆØ§ØªØ³Ø§Ø¨"><img src="images/social.png" alt="ÙˆØ§ØªØ³Ø§Ø¨" style="--i:0;"></a>
        <a href="https://www.instagram.com/samamrst?igsh=M2oxOGFqcW9sZjMw" target="_blank" title="Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…"><img src="images/instagram (1).png" alt="Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…" style="--i:2;"></a>
        <a href="https://www.tiktok.com/@samamrst?_r=1&_t=ZS-91NtHAHEunf" target="_blank" title="ØªÙŠÙƒ ØªÙˆÙƒ"><img src="images/tik-tok.png" alt="ØªÙŠÙƒ ØªÙˆÙƒ" style="--i:3;"></a>
        <a href="https://twitter.com/yourpage" target="_blank" title="X - ØªÙˆÙŠØªØ±"><img src="images/twitter.png" alt="X - ØªÙˆÙŠØªØ±" style="--i:4;"></a>
        <a href="https://maps.app.goo.gl/u3taVpScWA5DGfMRA" target="_blank" title="Ù…ÙˆÙ‚Ø¹Ù†Ø§"><img src="images/map.png" alt="Ù…ÙˆÙ‚Ø¹Ù†Ø§" style="--i:5;"></a>
      </div>
    </div>

    <div class="footer-delivery-section">
      <h4 class="section-title">Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø¹Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h4>
      <div class="delivery-icons">
        <a href="#" target="_blank"><img src="images/images.png" alt="ÙƒÙŠØªØ§" style="--i:1;"></a>
      </div>
    </div>
  </div>
  
  <div class="footer-bottom">
    <p>Â© 2025 ØµÙ…Ù‘Ø§Ù…. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
  </div>
</footer>

<div id="ad-overlay" style="display:none;"><div class="ad-box"><button class="close-ad">Ã—</button><div class="ad-image-wrapper"><img id="popup-ad-img" src="" alt="Ø¥Ø¹Ù„Ø§Ù†" /><a href="https://wa.me/966592372549" target="_blank" class="ad-btn">Ø§Ø¶ØºØ· Ù‡Ù†Ø§</a></div></div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signInAnonymously, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, getDoc, addDoc, serverTimestamp, query, where, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0bLzrTbWlgiSyIo9YUsJIp07L_bCclfg",
    authDomain: "samam-f3d54.firebaseapp.com",
    projectId: "samam-f3d54",
    storageBucket: "samam-f3d54.firebasestorage.app",
    messagingSenderId: "635639197847",
    appId: "1:635639197847:web:b61900b409114792a9b9d2",
    measurementId: "G-GQKHFZRENQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let cartItems = [];
  const deliveryFee = 15;
  let appliedDiscount = 0;
  let appliedCodeName = "";
  
  const categoryMap = {'Ø¯Ø¬Ø§Ø¬':'chicken','Ù„Ø­Ù…':'meat','Ø±Ø²':'rice','Ø·Ù„Ø¨Ø§Øª Ø¬Ø§Ù†Ø¨ÙŠØ©':'sides','Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª':'drinks'};

  // --- Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Persistence) ---
  const savedCart = localStorage.getItem('samam_cart');
  if (savedCart) {
      try {
          cartItems = JSON.parse(savedCart);
      } catch(e) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ù„Ø©", e);
      }
  }

  // --- Ø¥Ø¯Ø§Ø±Ø© Ø²Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± ---
  const headerUserBtn = document.getElementById('headerUserBtn');
  const userDropdown = document.getElementById('userDropdown');
  const headerLogoutBtn = document.getElementById('headerLogoutBtn');
  const openProfileBtn = document.getElementById('openProfileBtn');
  const openTrackBtnMobile = document.getElementById('openTrackModalBtnMobile');

  // ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
  function attachDropdownListeners() {
      // Ø¹Ù†Ø§ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø²Ø§Ø¦Ø± Ø£Ùˆ Ø¬ÙˆØ¬Ù„)
      const loginVisitorBtn = document.getElementById('loginVisitorBtn');
      const loginGoogleBtn = document.getElementById('loginGoogleBtn');
      
      // Ø¹Ù†Ø§ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬)
      const profileBtn = document.getElementById('openProfileBtn');
      const logoutBtn = document.getElementById('headerLogoutBtn');

      if (loginVisitorBtn) loginVisitorBtn.addEventListener('click', handleVisitorLogin);
      if (loginGoogleBtn) loginGoogleBtn.addEventListener('click', handleGoogleLogin);
      
      if (profileBtn) profileBtn.addEventListener('click', () => {
          if (!currentUser) return;
          const profileModal = document.getElementById('profileModalOverlay');
          const userDropdown = document.getElementById('userDropdown');
          profileModal.style.display = 'flex';
          userDropdown.classList.remove('show');
          loadUserProfile();
      });
      if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
  }

  // ØªØ¹Ø¯ÙŠÙ„: Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙŠÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Dropdown)
  if (headerUserBtn) {
      headerUserBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          // ÙÙŠ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ù…Ø³Ø¬Ù„ Ø£Ùˆ Ø²Ø§Ø¦Ø±) Ù†ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ ÙˆÙ…Ø­ØªÙˆØ§Ù‡Ø§ ÙŠØ®ØªÙ„Ù
          userDropdown.classList.toggle('show');
      });
  }

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener('click', (e) => {
      if (userDropdown && userDropdown.classList.contains('show') && !headerUserBtn.contains(e.target)) {
          userDropdown.classList.remove('show');
      }
  });

  // --- Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„ ---
  async function handleGoogleLogin() {
      console.log("Starting Google Login...");
      try {
          await setPersistence(auth, browserLocalPersistence);
          await signInWithPopup(auth, provider);
          console.log("Google Login Success");
      } catch (error) {
          console.error("Google Login Failed:", error);
          alert(`Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.`);
      }
  }

  // --- Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø± ---
  async function handleVisitorLogin() {
      console.log("Starting Anonymous Login...");
      try {
          await setPersistence(auth, browserLocalPersistence);
          await signInAnonymously(auth);
          console.log("Anonymous Login Success");
      } catch (error) {
          console.error("Anonymous Login Failed:", error);
          alert(`Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±.`);
      }
  }

  // --- Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ---
  function handleLogout() {
      signOut(auth).then(() => {
          alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
          location.reload();
      }).catch((error) => {
          console.error(error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
      });
  }

  // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
  onAuthStateChanged(auth, (user) => {
      currentUser = user;
      updateUserUI(user);
  });

  function updateUserUI(user) {
      const headerBtn = document.getElementById('headerUserBtn');
      const dropdown = document.getElementById('userDropdown');
      if (!headerBtn || !dropdown) return;

      if (user) {
          // --- Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
          headerBtn.classList.remove('visitor-mode');
          headerBtn.classList.add('logged-in-style');

          // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø¬ÙˆØ¬Ù„ Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØªØŒ Ø£Ùˆ ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø²Ø§Ø¦Ø±
          // fallback icon for anonymous users or missing photos
          const avatarUrl = user.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'; 
          
          headerBtn.innerHTML = `
              <img src="${avatarUrl}" class="header-user-avatar" alt="User">
          `;

          // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„
          dropdown.innerHTML = `
              <div class="user-dropdown-item" id="openProfileBtn">ğŸ“‚ Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
              <div class="user-dropdown-item logout-item" id="headerLogoutBtn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>
          `;
      } else {
          // --- Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø§Ø¦Ø± (ØºÙŠØ± Ù…Ø³Ø¬Ù„) ---
          headerBtn.classList.remove('logged-in-style');
          headerBtn.classList.add('visitor-mode'); 
          headerBtn.innerHTML = `
              <span class="header-user-icon">ğŸ‘¤</span>
              <!-- Ø§Ù„Ù†Øµ Ù…Ø®ÙÙŠ Ø¨Ù€ CSS -->
              <span>Ø¯Ø®ÙˆÙ„</span>
          `;
          
          // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø²Ø§Ø¦Ø± (Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„)
          dropdown.innerHTML = `
              <div class="user-dropdown-item" id="loginVisitorBtn" style="font-weight:bold;">ğŸ•¶ï¸ Ù…ØªØ§Ø¨Ø¹Ø© ÙƒØ²Ø§Ø¦Ø±</div>
              <div class="user-dropdown-item" id="loginGoogleBtn" style="font-weight:bold;">ğŸ‡¬ Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„</div>
          `;
      }
      
      // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      attachDropdownListeners();
  }

  // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Profile & History) ---
  const profileModal = document.getElementById('profileModalOverlay');
  const closeProfileBtn = document.getElementById('closeProfileModal');
  
  if(closeProfileBtn) closeProfileBtn.addEventListener('click', () => { profileModal.style.display = 'none'; });
  if(profileModal) profileModal.addEventListener('click', (e) => { if(e.target === profileModal) profileModal.style.display = 'none'; });

  async function loadUserProfile() {
      const content = document.getElementById('profileContent');
      const ordersList = document.getElementById('userOrdersList');
      
      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØµÙˆØ±Ø© Ø§Ù„Ø²Ø§Ø¦Ø± (Anonymous)
      const avatarUrl = currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
      const displayName = currentUser.displayName || (currentUser.isAnonymous ? 'Ø²Ø§Ø¦Ø±' : 'Ø¹Ù…ÙŠÙ„Ù†Ø§');
      const displayEmail = currentUser.email || 'Ø­Ø³Ø§Ø¨ Ø²Ø§Ø¦Ø± (Ù…Ø¤Ù‚Øª)';

      content.innerHTML = `
          <div class="profile-info">
              <img src="${avatarUrl}" class="profile-avatar-large">
              <div class="profile-name-large">${displayName}</div>
              <div class="profile-email">${displayEmail}</div>
          </div>
      `;
      
      ordersList.innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>';
      
      try {
          const q = query(collection(db, "orders"), where("userId", "==", currentUser.uid));
          const querySnapshot = await getDocs(q);
          
          if(querySnapshot.empty) {
              ordersList.innerHTML = '<p style="text-align:center; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.</p>';
          } else {
              let html = '';
              const orders = [];
              querySnapshot.forEach((doc) => { orders.push({id: doc.id, ...doc.data()}); });
              
              // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
              orders.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

              orders.forEach(order => {
                  const statusClass = `status-${order.status.replace(/\s+/g, '-')}`;
                  const itemsSummary = order.itemsString.split('\n')[0] + (order.itemsString.split('\n').length > 1 ? ' ...' : '');
                  
                  html += `
                      <div class="order-status-card">
                          <div style="display:flex; justify-content:space-between; align-items:center;">
                              <span style="font-weight:bold; color:#e65100;">#${String(order.createdAt?.seconds || '').slice(-4)}</span>
                              <div class="status-badge ${statusClass}">${order.status}</div>
                          </div>
                          <span class="order-date">${order.orderDateKSA || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span>
                          <hr style="margin:8px 0; border:0; border-top:1px dashed #eee;">
                          <p style="font-size:13px; color:#555; margin-bottom:5px;">${itemsSummary}</p>
                          <div style="font-weight:bold; font-size:14px; text-align:left;">${order.total} Ø±.Ø³</div>
                      </div>
                  `;
              });
              ordersList.innerHTML = html;
          }
      } catch (e) {
          console.error(e);
          ordersList.innerHTML = '<p style="color:red; text-align:center;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</p>';
      }
  }

  // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Rating Logic) ---
  const ratingModal = document.getElementById('ratingModalOverlay');
  const closeRatingBtn = document.getElementById('closeRatingModal');
  const submitRatingBtn = document.getElementById('submitRatingBtn');
  const ratingComment = document.getElementById('ratingComment');
  const ratingStars = document.querySelectorAll('input[name="rating"]');
  const googleMapLinkContainer = document.getElementById('googleMapLinkContainer');

  function openRatingModal() {
      // Reset form
      ratingStars.forEach(s => s.checked = false);
      ratingComment.value = "";
      googleMapLinkContainer.style.display = 'none';
      submitRatingBtn.style.display = 'block';
      ratingModal.style.display = 'flex';
  }

  if (closeRatingBtn) closeRatingBtn.addEventListener('click', () => { ratingModal.style.display = 'none'; });

  if (submitRatingBtn) {
      submitRatingBtn.addEventListener('click', async () => {
          let selectedRating = 0;
          ratingStars.forEach(s => { if(s.checked) selectedRating = s.value; });
          
          if (selectedRating === 0) {
              alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ…");
              return;
          }

          const comment = ratingComment.value.trim();
          submitRatingBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
          submitRatingBtn.disabled = true;

          try {
              // --- ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ğŸ”¥ ---
              await addDoc(collection(db, 'ratings'), {
                  rating: parseInt(selectedRating),
                  comment: comment,
                  customerName: currentUser ? currentUser.displayName : 'Ø²Ø§Ø¦Ø±',
                  customerId: currentUser ? currentUser.uid : null,
                  customerEmail: currentUser ? currentUser.email : null, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                  customerPhoto: currentUser ? currentUser.photoURL : null, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø©
                  createdAt: serverTimestamp()
              });

              // Show success UI inside modal
              submitRatingBtn.style.display = 'none';
              googleMapLinkContainer.style.display = 'block';
              
          } catch (e) {
              console.error(e);
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…");
              submitRatingBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…";
              submitRatingBtn.disabled = false;
          }
      });
  }


  async function trackVisit() {
      if (sessionStorage.getItem('visited')) return;
      const analyticsRef = doc(db, 'analytics', 'visitors');
      const today = new Date().toLocaleDateString('en-CA');
      const currentMonth = today.slice(0, 7);
      try {
          const docSnap = await getDoc(analyticsRef);
          if (!docSnap.exists()) {
              await setDoc(analyticsRef, { total: 1, [`daily_${today}`]: 1, [`monthly_${currentMonth}`]: 1 });
          } else {
              await updateDoc(analyticsRef, { total: increment(1), [`daily_${today}`]: increment(1), [`monthly_${currentMonth}`]: increment(1) });
          }
          sessionStorage.setItem('visited', 'true');
      } catch (e) { console.log("Analytics Error (Silent):", e); }
  }

  async function loadData() {
    trackVisit();
    updateCartUI(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    const loadingMsg = document.getElementById('loading-msg');
    try {
      const settingsDoc = await getDoc(doc(db, 'settings', 'general'));
      if (settingsDoc.exists()) {
          const settings = settingsDoc.data();
          if(settings.heroTitle) document.getElementById('hero-title-text').innerText = settings.heroTitle;
          if(settings.heroImage) document.getElementById('hero-img-element').src = settings.heroImage;
          const announcementBar = document.getElementById('announcement-bar');
          if(settings.showAnnouncement && settings.announcement) {
              announcementBar.style.display = 'flex';
              document.getElementById('announcement-text').innerText = settings.announcement;
              if (settings.announcementBgColor) announcementBar.style.backgroundColor = settings.announcementBgColor;
              if (settings.announcementTextColor) announcementBar.style.color = settings.announcementTextColor;
              document.body.style.paddingTop = announcementBar.offsetHeight + 'px';
          }
          const adOverlay = document.getElementById('ad-overlay');
          const popupImg = document.getElementById('popup-ad-img');
          if(settings.showPopup && settings.popupImage) {
              popupImg.src = settings.popupImage;
              adOverlay.style.display = 'flex';
          } else {
              adOverlay.style.display = 'none';
          }
      }

      const querySnapshot = await getDocs(collection(db, 'menu'));
      if (querySnapshot.empty) {
          if (loadingMsg) loadingMsg.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.";
          return;
      }
      
      if (loadingMsg) loadingMsg.style.display = 'none';
      Object.values(categoryMap).forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = ''; });
      
      const menuItems = [];
      querySnapshot.forEach((doc) => { menuItems.push({ id: doc.id, ...doc.data() }); });
      menuItems.sort((a, b) => (a.order || 999) - (b.order || 999));

      menuItems.forEach((item) => {
        try {
            if (item.status === 'ØºÙŠØ± Ù…ØªØ§Ø­') return;
            const catKey = (item.category || '').trim();
            const containerId = categoryMap[catKey] || 'chicken';
            const container = document.getElementById(containerId);
            
            if (container) {
              let sizesHTML = '';
              let basePrice = item.price || 0;
              
              if (item.hasSizes && item.sizes && Array.isArray(item.sizes) && item.sizes.length > 0) {
                  basePrice = 0; 
                  sizesHTML = `<div class="menu-item-size">${item.sizes.map((s, index) => `<button class="size-btn" data-index="${index}" onclick="selectSize(this)">${s.name}</button>`).join('')}</div>`;
              }
              let typeHTML = '';
              if (item.hasPlainOption) {
                  typeHTML = `<div class="menu-item-type"><label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨:</label><select class="type-select custom-select" onchange="handleTypeChange(this)"><option value="" disabled selected hidden>Ø§Ø®ØªØ± (Ø³Ø§Ø¯Ø© / Ù…Ø¹ Ø§Ù„Ø±Ø²)</option><option value="plain">Ø³Ø§Ø¯Ø©</option><option value="with_rice">Ù…Ø¹ Ø§Ù„Ø±Ø²</option></select></div>`;
              }
              let riceHTML = '';
              if (item.hasRiceSelection && item.riceTypes && Array.isArray(item.riceTypes) && item.riceTypes.length > 0) {
                  riceHTML = `<div class="menu-item-rice" style="${item.hasPlainOption ? 'display:none;' : ''}"><label>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø²:</label><select class="rice-select custom-select" onchange="calculateCardPrice(this)"><option value="" disabled selected hidden>Ø¨Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø²</option>${item.riceTypes.map(r => { const rName = typeof r === 'object' ? r.name : r; const rPrice = typeof r === 'object' ? (r.price || 0) : 0; const label = rPrice > 0 ? `${rName} (+${rPrice} Ø±.Ø³)` : rName; return `<option value="${rName}" data-extra="${rPrice}">${label}</option>`; }).join('')}</select></div>`;
              }
              
              let sizesDataSafe = '';
              if (item.hasSizes && Array.isArray(item.sizes)) {
                  sizesDataSafe = encodeURIComponent(JSON.stringify(item.sizes));
              }
              
              const discountVal = parseInt(item.discount) || 0;
              const discountBadge = (discountVal > 0) ? `<div class="discount-badge">Ø®ØµÙ… ${discountVal}%</div>` : '';

              const cardHTML = `
                <div class="menu-item-card" data-id="${item.id}" data-base-price="${item.price || 0}" data-has-plain="${item.hasPlainOption || false}" data-sizes="${sizesDataSafe}" data-discount="${discountVal}">
                  ${discountBadge}
                  <div class="menu-item-img">${item.image ? `<img src="${item.image}" alt="${item.name}" onerror="this.src='images/logo p.png'">` : ''}<span class="calories">${item.calories || ''}</span></div>
                  <h3 class="menu-item-title">${item.name}</h3>
                  ${sizesHTML}${typeHTML}${riceHTML}
                  <div class="menu-item-quantity"><label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label><div class="quantity-box"><button type="button" class="qty-btn minus" onclick="updateCardQty(this, -1)">âˆ’</button><span class="quantity-input">1</span><button type="button" class="qty-btn plus" onclick="updateCardQty(this, 1)">+</button></div></div>
                  <div class="menu-item-price"><p class="new-price">Ø§Ù„Ø³Ø¹Ø± : <span class="price price-display">${basePrice > 0 ? basePrice : '0'}</span> Ø±.Ø³</p></div>
                  <button class="add-to-cart" disabled onclick="addToCart(this)">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ</button>
                </div>
              `;
              container.insertAdjacentHTML('beforeend', cardHTML);
              if (container.lastElementChild) validateSelection(container.lastElementChild);
            }
        } catch (itemError) { console.error("Error rendering item:", itemError); }
      });
    } catch (error) { 
        console.error("Error loading data:", error);
        if (loadingMsg) loadingMsg.innerText = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    }
  }

  const menuToggle = document.getElementById('menuToggle');
  const mobileMenu = document.getElementById('mobileMenu');
  if (menuToggle && mobileMenu) {
      menuToggle.addEventListener('click', () => { mobileMenu.classList.toggle('open'); });
  }

  document.querySelectorAll('.mobile-menu a').forEach(link => {
      link.addEventListener('click', (e) => {
          if (link.id !== 'toggleAboutBtn' && link.id !== 'openTrackModalBtn') { mobileMenu.classList.remove('open'); }
      });
  });

  const aboutSection = document.getElementById('about');
  const toggleAboutBtn = document.getElementById('toggleAboutBtn');
  if (toggleAboutBtn && aboutSection) {
      toggleAboutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (aboutSection.classList.contains('hidden')) { 
              aboutSection.classList.remove('hidden'); 
              mobileMenu.classList.remove('open'); 
              aboutSection.scrollIntoView({ behavior: 'smooth' }); 
              const boxes = document.querySelectorAll('.about-box'); 
              boxes.forEach(box => { box.style.opacity = '1'; box.style.transform = 'translateY(0)'; }); 
          } else { 
              aboutSection.classList.add('hidden'); 
              mobileMenu.classList.remove('open'); 
          }
      });
  }

  window.handleTypeChange = function(select) {
      const card = select.closest('.menu-item-card');
      const riceDiv = card.querySelector('.menu-item-rice');
      if (riceDiv) {
          if (select.value === 'plain') { riceDiv.style.display = 'none'; const riceSelect = riceDiv.querySelector('select'); if(riceSelect) riceSelect.value = ""; } else { riceDiv.style.display = 'block'; }
      }
      calculateCardPrice(select);
  };

  window.validateSelection = function(card) {
      const riceSelect = card.querySelector('.rice-select');
      const typeSelect = card.querySelector('.type-select');
      const sizeBtns = card.querySelectorAll('.size-btn');
      const addBtn = card.querySelector('.add-to-cart');
      let isValid = true;
      let btnText = "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ";

      if (sizeBtns.length > 0 && !card.querySelector('.size-btn.active')) { isValid = false; btnText = "Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¬Ù…"; }
      if (typeSelect && typeSelect.value === "") { isValid = false; if(btnText === "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ") btnText = "Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨"; }
      const riceDiv = card.querySelector('.menu-item-rice');
      if (riceDiv && riceDiv.style.display !== 'none' && riceSelect && riceSelect.value === "") { isValid = false; if(btnText === "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ") btnText = "Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø²"; }

      if (isValid) { addBtn.disabled = false; addBtn.innerText = "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ù„Ø© Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ"; addBtn.style.opacity = "1"; calculateCardPrice(addBtn); } 
      else { addBtn.disabled = true; addBtn.innerText = btnText; addBtn.style.opacity = "0.6"; }
  };

  window.selectSize = function(btn) {
      const card = btn.closest('.menu-item-card');
      const sizeBtns = card.querySelectorAll('.size-btn');
      sizeBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      calculateCardPrice(btn);
      validateSelection(card);
  };

  window.updateCardQty = function(btn, change) {
      const input = btn.parentElement.querySelector('.quantity-input');
      let val = parseInt(input.innerText);
      val += change;
      if (val < 1) val = 1;
      input.innerText = val;
      calculateCardPrice(btn);
  };

  window.calculateCardPrice = function(element) {
      const card = element.closest('.menu-item-card');
      if (!card) return;

      const priceDisplay = card.querySelector('.price-display');
      const qty = parseInt(card.querySelector('.quantity-input').innerText);
      const hasPlain = card.dataset.hasPlain === 'true';
      const discountPercent = parseFloat(card.dataset.discount) || 0;
      
      let sizes = [];
      if (card.dataset.sizes && card.dataset.sizes !== "undefined") { 
        try { sizes = JSON.parse(decodeURIComponent(card.dataset.sizes)); } catch(e){} 
      }

      let unitPrice = parseFloat(card.dataset.basePrice) || 0;
      const activeSizeBtn = card.querySelector('.size-btn.active');
      if (activeSizeBtn && sizes.length > 0) {
          const index = parseInt(activeSizeBtn.dataset.index);
          const sizeObj = sizes[index];
          if (hasPlain) {
              const typeSelect = card.querySelector('.type-select');
              if (typeSelect && typeSelect.value === 'plain') unitPrice = parseFloat(sizeObj.plainPrice) || 0;
              else if (typeSelect && typeSelect.value === 'with_rice') unitPrice = parseFloat(sizeObj.ricePrice) || 0;
              else unitPrice = 0;
          } else {
              unitPrice = parseFloat(sizeObj.price) || 0;
          }
      }

      let extraPrice = 0;
      const riceSelect = card.querySelector('.rice-select');
      const riceDiv = card.querySelector('.menu-item-rice');
      if (riceDiv && riceDiv.style.display !== 'none' && riceSelect && riceSelect.value !== "") {
          const selectedOption = riceSelect.options[riceSelect.selectedIndex];
          extraPrice = parseFloat(selectedOption.dataset.extra) || 0;
      }

      let discountedUnitPrice = unitPrice;
      if (discountPercent > 0) { discountedUnitPrice = unitPrice - (unitPrice * (discountPercent / 100)); }

      const finalUnitPrice = discountedUnitPrice + extraPrice;
      const totalPrice = finalUnitPrice * qty;

      if (discountPercent > 0 && unitPrice > 0) {
           priceDisplay.innerHTML = `<span class="old-price">${((unitPrice + extraPrice) * qty).toFixed(1)}</span> ${totalPrice.toFixed(1)}`;
      } else {
           priceDisplay.innerText = totalPrice.toFixed(1);
      }
      
      if (element.tagName === 'SELECT') validateSelection(card);
  };

  window.addToCart = function(btn) {
      const card = btn.closest('.menu-item-card');
      const title = card.querySelector('.menu-item-title').innerText;
      const qty = parseInt(card.querySelector('.quantity-input').innerText);
      
      const discountPercent = parseFloat(card.dataset.discount) || 0;
      let sizes = [];
      if (card.dataset.sizes) try { sizes = JSON.parse(decodeURIComponent(card.dataset.sizes)); } catch(e){}
      const hasPlain = card.dataset.hasPlain === 'true';

      let baseUnitPrice = parseFloat(card.dataset.basePrice) || 0;
      let sizeName = "";
      
      const activeSizeBtn = card.querySelector('.size-btn.active');
      if (activeSizeBtn && sizes.length > 0) {
          sizeName = activeSizeBtn.innerText;
          const index = parseInt(activeSizeBtn.dataset.index);
          const sizeObj = sizes[index];
          if (hasPlain) {
              const typeSelect = card.querySelector('.type-select');
              if (typeSelect && typeSelect.value === 'plain') baseUnitPrice = parseFloat(sizeObj.plainPrice) || 0;
              else if (typeSelect && typeSelect.value === 'with_rice') baseUnitPrice = parseFloat(sizeObj.ricePrice) || 0;
          } else {
              baseUnitPrice = parseFloat(sizeObj.price) || 0;
          }
      }

      let extraPrice = 0;
      const riceSelect = card.querySelector('.rice-select');
      const riceDiv = card.querySelector('.menu-item-rice');
      let riceName = "";
      if (riceDiv && riceDiv.style.display !== 'none' && riceSelect && riceSelect.value !== "") {
          riceName = riceSelect.value;
          const selectedOption = riceSelect.options[riceSelect.selectedIndex];
          extraPrice = parseFloat(selectedOption.dataset.extra) || 0;
      }

      let finalBasePrice = baseUnitPrice;
      if (discountPercent > 0) { finalBasePrice = baseUnitPrice - (baseUnitPrice * (discountPercent / 100)); }
      const finalUnitPrice = finalBasePrice + extraPrice;

      let details = sizeName ? `(${sizeName})` : "";
      const typeSelect = card.querySelector('.type-select');
      if (typeSelect && typeSelect.value) { details += ` - ${typeSelect.options[typeSelect.selectedIndex].text}`; }

      const cartItem = { title: title, size: details, rice: riceName, price: finalUnitPrice, qty: qty };
      const existingItem = cartItems.find(i => i.title === cartItem.title && i.size === cartItem.size && i.rice === cartItem.rice);
      if (existingItem) existingItem.qty += qty; else cartItems.push(cartItem);

      updateCartUI();
      openCart();
      const originalText = btn.innerText; btn.innerText = "ØªÙ… âœ“"; btn.style.background = "#22c55e"; setTimeout(() => { btn.innerText = originalText; btn.style.background = ""; }, 1000);
  };

  function updateCartUI() {
      const container = document.getElementById('cartItems_v2');
      const countEl = document.querySelector('.cart-count');
      const totalEl = document.getElementById('cartTotal_v2');
      const deliverySelect = document.getElementById('deliveryMethod_v2');
      container.innerHTML = '';
      let subtotal = 0;
      let totalQty = 0;

      if (cartItems.length === 0) { container.innerHTML = '<p class="empty-cart">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§</p>'; } 
      else {
          cartItems.forEach((item, idx) => {
              const itemTotal = item.price * item.qty;
              subtotal += itemTotal;
              totalQty += item.qty;
              const div = document.createElement('div');
              div.className = 'cart-item';
              div.innerHTML = `<div class="cart-item-header"><strong>${item.title}</strong><button class="remove-item" onclick="window.removeCartItem(${idx})">ğŸ—‘</button></div><div class="cart-item-details"><small style="color:#666">${item.size || ''}</small>${item.rice ? `<br><small style="color:#e65100">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø²: ${item.rice}</small>` : ''}</div><div class="cart-controls"><button class="qty-btn" onclick="window.changeCartQty(${idx}, -1)">-</button><span class="qty-number">${item.qty}</span><button class="qty-btn" onclick="window.changeCartQty(${idx}, 1)">+</button><span class="item-total">${itemTotal.toFixed(1)} Ø±.Ø³</span></div>`;
              container.appendChild(div);
          });
      }
      const isDelivery = deliverySelect.value === 'ØªÙˆØµÙŠÙ„';
      const currentDeliveryFee = isDelivery ? deliveryFee : 0;
      const discountVal = subtotal * appliedDiscount;
      const finalTotal = subtotal + currentDeliveryFee - discountVal;
      countEl.innerText = totalQty;
      let totalHTML = `<div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${subtotal.toFixed(1)} Ø±.Ø³</div>`;
      if(isDelivery) totalHTML += `<div>Ø§Ù„ØªÙˆØµÙŠÙ„: ${currentDeliveryFee} Ø±.Ø³</div>`;
      if(discountVal > 0) totalHTML += `<div style="color:green">Ø®ØµÙ… (${appliedCodeName}): -${discountVal.toFixed(1)} Ø±.Ø³</div>`;
      totalHTML += `<div style="font-weight:bold; font-size:1.2em; margin-top:5px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${finalTotal.toFixed(1)} Ø±.Ø³</div>`;
      totalEl.innerHTML = totalHTML;

      // Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      localStorage.setItem('samam_cart', JSON.stringify(cartItems));
  }

  window.changeCartQty = function(idx, change) { if (cartItems[idx]) { cartItems[idx].qty += change; if (cartItems[idx].qty < 1) cartItems[idx].qty = 1; updateCartUI(); } };
  window.removeCartItem = function(idx) { cartItems.splice(idx, 1); updateCartUI(); };
  
  const cartSlider = document.getElementById('cartSlider_v2');
  const overlay = document.createElement('div'); overlay.className = 'cart-overlay'; document.body.appendChild(overlay);
  function openCart() { cartSlider.classList.add('open'); overlay.classList.add('show'); }
  function closeCart() { cartSlider.classList.remove('open'); overlay.classList.remove('show'); }
  document.querySelector('.cart-container').addEventListener('click', openCart);
  document.getElementById('closeCart_v2').addEventListener('click', closeCart);
  overlay.addEventListener('click', closeCart);

  document.getElementById('deliveryMethod_v2').addEventListener('change', (e) => {
      const val = e.target.value;
      const carFields = document.getElementById('carFields');
      const deliveryFields = document.getElementById('deliveryFields');
      carFields.style.display = 'none'; deliveryFields.style.display = 'none';
      if (val === 'ØªØ³Ù„ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©') carFields.style.display = 'block'; else if (val === 'ØªÙˆØµÙŠÙ„') deliveryFields.style.display = 'block';
      updateCartUI();
  });

  document.getElementById('applyDiscountBtn_v2').addEventListener('click', async () => {
      const codeInput = document.getElementById('discountCode_v2');
      const code = codeInput.value.trim().toUpperCase();
      const msg = document.getElementById('discountMessage_v2');
      const btn = document.getElementById('applyDiscountBtn_v2');
      
      if (!code) return;
      
      // Condition 1: Not logged in OR Logged in anonymously
      if (!currentUser || currentUser.isAnonymous) {
          // Trigger Google Login directly
          handleGoogleLogin();
          return;
      }

      btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚..."; btn.disabled = true;
      try {
          const q = query(collection(db, "discounts"), where("code", "==", code));
          const querySnapshot = await getDocs(q);
          if (querySnapshot.empty) { 
              msg.innerText = "ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­"; 
              msg.style.color = "red"; 
              appliedDiscount = 0; 
              appliedCodeName = ""; 
          } 
          else {
              let discountData = null; 
              querySnapshot.forEach((doc) => { discountData = doc.data(); });
              
              if (discountData && discountData.active) {
                  // Check usage in Firestore using userID and code (One-time usage check)
                  // We check query collection 'discount_usage'
                  const usageQuery = query(collection(db, 'discount_usage'), 
                      where('userId', '==', currentUser.uid),
                      where('code', '==', code)
                  );
                  const usageSnap = await getDocs(usageQuery);
                  
                  if (usageSnap.size >= discountData.perUserLimit) {
                      msg.innerText = "Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹";
                      msg.style.color = "red";
                      appliedDiscount = 0;
                      appliedCodeName = "";
                  } else {
                      appliedDiscount = discountData.value;
                      appliedCodeName = code;
                      msg.innerText = `ØªÙ… Ø®ØµÙ… ${(appliedDiscount * 100)}%`;
                      msg.style.color = "green";
                  }
              } else { 
                  msg.innerText = "Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ÙØ¹Ø§Ù„"; 
                  msg.style.color = "red"; 
                  appliedDiscount = 0; 
              }
          }
      } catch (error) { 
          console.error(error);
          msg.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚"; 
          msg.style.color = "red"; 
      }
      btn.innerText = "ØªØ·Ø¨ÙŠÙ‚"; btn.disabled = false; updateCartUI();
  });

  document.getElementById('sendOrder_v2').addEventListener('click', async () => {
      if (cartItems.length === 0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");
      const name = document.getElementById('customerName').value.trim();
      const phone = document.getElementById('customerPhone').value.trim();
      const deliveryMethod = document.getElementById('deliveryMethod_v2').value;
      const paymentMethod = document.getElementById('paymentMethod_v2').value;
      if (!name || !phone) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");

      let extraDetails = "";
      if (deliveryMethod === 'ØªÙˆØµÙŠÙ„') {
          const address = document.getElementById('addressDetail').value.trim();
          const landmark = document.getElementById('landmark').value.trim();
          if (!address) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");
          extraDetails = `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${address}\nØ¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©: ${landmark}`;
      } else if (deliveryMethod === 'ØªØ³Ù„ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©') {
          const type = document.getElementById('carType').value.trim();
          const plate = document.getElementById('carPlate').value.trim();
          if (!type || !plate) return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ø·Ù„ÙˆØ¨Ø©");
          extraDetails = `Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${type} - ${plate}`;
      }

      // ØªØ¬Ù‡ÙŠØ² Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)
      let subtotal = 0;
      let itemsMsg = "";
      const itemsDetailsForDb = cartItems.map(item => {
          subtotal += item.price * item.qty;
          
          // Ø¨Ù†Ø§Ø¡ Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù
          itemsMsg += `Ø§Ù„ØµÙ†Ù: ${item.title} ${item.size}\n`;
          if (item.rice) {
              itemsMsg += `Ù†ÙˆØ¹ Ø§Ù„Ø±Ø²: ${item.rice}\n`;
          }
          itemsMsg += `Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.qty}\n`;
          itemsMsg += `----------------\n`;

          // Ø¨Ù†Ø§Ø¡ Ù†Øµ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø®ØªØµØ±)
          let detail = `- ${item.title} ${item.size} (Ø¹Ø¯Ø¯ ${item.qty})`;
          if (item.rice) detail += ` [Ø±Ø²: ${item.rice}]`;
          return detail;
      }).join('\n');

      const isDelivery = deliveryMethod === 'ØªÙˆØµÙŠÙ„';
      const currentDeliveryFee = isDelivery ? deliveryFee : 0;
      const discountVal = subtotal * appliedDiscount;
      const finalTotalVal = subtotal + currentDeliveryFee - discountVal;

      let msg = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ÙˆÙ‚Ø¹ ØµÙ…Ù‘Ø§Ù…*\n`;
      msg += `========================\n`;
      msg += `*Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„*\n`;
      msg += `Ø§Ù„Ø§Ø³Ù…: ${name}\n`;
      msg += `Ø§Ù„Ø¬ÙˆØ§Ù„: ${phone}\n`;
      msg += `========================\n`;
      msg += `*ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨*\n`;
      msg += itemsMsg;
      
      msg += `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: ${subtotal.toFixed(1)} Ø±ÙŠØ§Ù„\n`;
      
      if (currentDeliveryFee > 0) {
          msg += `Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: ${currentDeliveryFee} Ø±ÙŠØ§Ù„\n`;
      }
      
      if (discountVal > 0) {
          msg += `Ø§Ù„Ø®ØµÙ…: -${discountVal.toFixed(1)} Ø±ÙŠØ§Ù„\n`;
      }
      
      msg += `*Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${finalTotalVal.toFixed(1)} Ø±ÙŠØ§Ù„*\n`;
      msg += `========================\n`;
      msg += `Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${paymentMethod}\n`;
      msg += `Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ${deliveryMethod}\n`;
      
      if (extraDetails) {
          msg += `\n*ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:*\n${extraDetails}\n`;
      }

      const now = new Date();
      const ksaDateString = now.toLocaleString('ar-SA', { timeZone: 'Asia/Riyadh', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true });

      try {
          const orderData = {
              itemsString: itemsDetailsForDb, 
              total: finalTotalVal.toFixed(1), 
              status: 'Ø¬Ø¯ÙŠØ¯', 
              customerName: name, 
              phone: phone, 
              deliveryType: deliveryMethod, 
              deliveryDetails: extraDetails, 
              paymentType: paymentMethod, 
              orderDateKSA: ksaDateString, 
              createdAt: serverTimestamp()
          };
          
          // --- ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø§Ù…: Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„ØµÙˆØ±Ø© ğŸ”¥ ---
          if (currentUser) {
              orderData.userId = currentUser.uid;
              orderData.userEmail = currentUser.email;
              orderData.userPhoto = currentUser.photoURL;
          }

          await addDoc(collection(db, 'orders'), orderData);
          
          // Record discount usage if applied
          if (appliedCodeName && currentUser) { 
              await addDoc(collection(db, 'discount_usage'), {
                  userId: currentUser.uid,
                  code: appliedCodeName,
                  usedAt: serverTimestamp()
              });
          }

          // Show Rating Modal after order
          openRatingModal();

          // Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¬Ø­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù„ÙƒÙ† Ø£ÙØ¶Ù„ Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
          // cartItems = [];
          // updateCartUI();

      } catch(e) { console.error("Error", e); }
      
      // ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
      window.open(`https://wa.me/966592372549?text=${encodeURIComponent(msg)}`, '_blank');
  });

  const tabs = document.querySelectorAll('.category-btn');
  tabs.forEach(btn => {
      btn.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active')); btn.classList.add('active');
          const cat = btn.dataset.category;
          document.querySelectorAll('.menu-group').forEach(g => {
              if (cat === 'all' || g.id === cat) { g.style.display = 'flex'; g.style.opacity = '0'; setTimeout(() => g.style.opacity = '1', 50); } else { g.style.display = 'none'; }
          });
      });
  });

  // --- Ù…Ù†Ø·Ù‚ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ ---
  const trackModal = document.getElementById('trackModalOverlay');
  const openTrackBtn = document.getElementById('openTrackModalBtn');
  const closeTrackBtn = document.getElementById('closeTrackModal');
  const searchOrderBtn = document.getElementById('searchOrderBtn');
  const trackInput = document.getElementById('trackPhoneInput');
  const trackResults = document.getElementById('trackResults');

  if(openTrackBtn) {
      openTrackBtn.addEventListener('click', (e) => {
          e.preventDefault();
          trackModal.style.display = 'flex';
          mobileMenu.classList.remove('open');
      });
  }
  if(closeTrackBtn) {
      closeTrackBtn.addEventListener('click', () => { trackModal.style.display = 'none'; });
  }
  if(trackModal) {
      trackModal.addEventListener('click', (e) => { if(e.target === trackModal) trackModal.style.display = 'none'; });
  }

  if(searchOrderBtn) {
      searchOrderBtn.addEventListener('click', async () => {
          const phone = trackInput.value.trim();
          if(!phone) {
              trackResults.innerHTML = '<p style="color:red;text-align:center;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</p>';
              return;
          }
          
          trackResults.innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
          searchOrderBtn.disabled = true;

          try {
              const q = query(collection(db, "orders"), where("phone", "==", phone));
              const querySnapshot = await getDocs(q);
              
              if(querySnapshot.empty) {
                  trackResults.innerHTML = '<p style="color:#666;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</p>';
              } else {
                  let ordersHTML = '';
                  const orders = [];
                  querySnapshot.forEach((doc) => { orders.push({id: doc.id, ...doc.data()}); });
                  
                  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ø£Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ ÙŠØ­ØªØ§Ø¬ Ø¥Ù†Ø¯ÙƒØ³ Ù„Ù„ØªØ±ØªÙŠØ¨ Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø©
                  orders.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                  orders.forEach(order => {
                      const statusClass = `status-${order.status.replace(/\s+/g, '-')}`;
                      // ØªÙ„Ø®ÙŠØµ Ø§Ù„Ø£ØµÙ†Ø§Ù
                      const itemsSummary = order.itemsString.split('\n')[0] + (order.itemsString.split('\n').length > 1 ? ' ...' : '');
                      
                      ordersHTML += `
                          <div class="order-status-card">
                              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                  <span style="font-weight:bold;">#${String(order.createdAt?.seconds || '').slice(-4)}</span>
                                  <span style="font-size:12px; color:#888;">${order.orderDateKSA ? order.orderDateKSA.split(',')[0] : ''}</span>
                              </div>
                              <div class="status-badge ${statusClass}">${order.status}</div>
                              <p style="font-size:13px; color:#555; margin-bottom:5px;">${itemsSummary}</p>
                              <div style="font-weight:bold; font-size:14px; text-align:left;">${order.total} Ø±.Ø³</div>
                          </div>
                      `;
                  });
                  trackResults.innerHTML = ordersHTML;
              }
          } catch(error) {
              console.error("Track Error:", error);
              trackResults.innerHTML = '<p style="color:red;text-align:center;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«</p>';
          }
          searchOrderBtn.disabled = false;
      });
  }

  document.querySelector('.close-ad').addEventListener('click', () => { document.getElementById('ad-overlay').style.display = 'none'; });
  let lastScroll = 0;
  window.addEventListener('scroll', () => {
      const current = window.scrollY; const header = document.getElementById('headerBg');
      if (current > lastScroll && current > 100) header.style.transform = 'translateY(-100%)'; else header.style.transform = 'translateY(0)';
      lastScroll = current;
  });
  window.onload = loadData;
</script>

</body>
</html>