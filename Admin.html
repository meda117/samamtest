<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØµÙ…Ù‘Ø§Ù… - Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            surface: '#1e293b',
                            border: '#334155'
                        }
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dir-ltr { direction: ltr; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .print-container { padding: 20px; width: 100%; }
            table { width: 100% !important; border: 1px solid #000 !important; }
            th, td { border: 1px solid #000 !important; padding: 5px !important; color: #000 !important; }
            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        }
        .print-only { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .table-wrapper {
            width: 100%;
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            background: white;
            position: relative;
        }
        .dark .table-wrapper {
            border-color: #334155;
            background: #1e293b;
        }
        table { 
            min-width: 800px; 
            width: 100%;
            border-collapse: collapse;
        }
        
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }

        /* Chart Tooltip Animation */
        .chart-bar:hover .chart-tooltip { display: block; }
        
        /* Modal Animation */
        .modal-animate { animation: zoomIn 0.2s ease-out forwards; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Notification Badge Pulse */
        .pulse-badge { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Live Toast Animation */
        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 20px); opacity: 1; } }
        .toast-animate { animation: slideDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @media (max-width: 768px) {
            .sidebar-mobile {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                width: 80%;
                max-width: 300px;
                z-index: 50;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }
            .sidebar-mobile.open { transform: translateX(0); }
            .size-row { flex-direction: column !important; align-items: stretch !important; gap: 0.5rem; }
            .size-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .dashboard-grid { grid-template-columns: 1fr; gap: 1rem; }
            header { padding: 1rem; }
            header h2 { font-size: 1rem; }
            .modal-content { max-width: 95vw; max-height: 90vh; }
            .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; }
            .sidebar-overlay.open { display: block; }
        }
    </style>
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.7.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LayoutDashboard, ShoppingBag, UtensilsCrossed, Settings, 
            Menu, X, Plus, Trash2, Edit, Save, Loader2, Image as ImageIcon, 
            Megaphone, Filter, Scale, Split, MousePointerClick, Palette, Tag, 
            User, MapPin, Clock, Calendar, FileText, Printer, Lock, LogOut, 
            BarChart3, TrendingUp, Users, ShieldCheck, RefreshCw, Percent, 
            Receipt, Phone, Bell, Moon, Sun, Star, MessageSquare, Share2, 
            Download, BadgeCheck, Search, Mail, Wifi, WifiOff, Database,
            ChefHat, Layers, Ban, Eye
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, updateDoc, 
            deleteDoc, doc, onSnapshot, serverTimestamp, setDoc, getDoc, writeBatch, getDocs, query, where,
            enableIndexedDbPersistence
        } from 'firebase/firestore';

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ ---
        const firebaseConfig = {
            apiKey: "AIzaSyB0bLzrTbWlgiSyIo9YUsJIp07L_bCclfg",
            authDomain: "samam-f3d54.firebaseapp.com",
            projectId: "samam-f3d54",
            storageBucket: "samam-f3d54.firebasestorage.app",
            messagingSenderId: "635639197847",
            appId: "1:635639197847:web:b61900b409114792a9b9d2",
            measurementId: "G-GQKHFZRENQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        try {
            enableIndexedDbPersistence(db).catch((err) => {
                if (err.code == 'failed-precondition') console.warn('Persistence failed: Multiple tabs open');
                else if (err.code == 'unimplemented') console.warn('Persistence not supported');
            });
        } catch (e) { console.log("Persistence setup error:", e); }

        const FIXED_CATEGORIES = ["ÙˆØ¬Ø¨Ø§Øª Ø±Ù…Ø¶Ø§Ù†", "Ø¯Ø¬Ø§Ø¬", "Ù„Ø­Ù…", "Ø±Ø²", "Ø·Ù„Ø¨Ø§Øª Ø¬Ø§Ù†Ø¨ÙŠØ©", "Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª"];

        // --- Ù…ÙƒÙˆÙ† Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ (Toggleable Chart) ---
        const ToggleableChart = ({ title, data7, labels7, data30, labels30, colorClass, suffix = "" }) => {
            const [period, setPeriod] = useState(7); 
            const currentData = period === 7 ? data7 : data30;
            const currentLabels = period === 7 ? labels7 : labels30;
            const maxValue = Math.max(...currentData, 1);

            return (
                <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm w-full transition-colors">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-lg text-slate-700 dark:text-slate-200">{title}</h3>
                        <div className="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                            <button onClick={() => setPeriod(7)} className={`px-3 py-1 text-xs font-bold rounded-md transition ${period === 7 ? 'bg-white dark:bg-slate-600 shadow text-slate-800 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>7 Ø£ÙŠØ§Ù…</button>
                            <button onClick={() => setPeriod(30)} className={`px-3 py-1 text-xs font-bold rounded-md transition ${period === 30 ? 'bg-white dark:bg-slate-600 shadow text-slate-800 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>30 ÙŠÙˆÙ…</button>
                        </div>
                    </div>
                    <div className="flex items-end gap-1 h-48 border-b border-l border-slate-200 dark:border-slate-700 p-2 relative">
                        {currentData.map((value, index) => {
                            const heightPercentage = (value / maxValue) * 100;
                            return (
                                <div key={index} className="flex-1 flex flex-col items-center gap-1 group relative chart-bar h-full justify-end">
                                    <div className="chart-tooltip absolute bottom-full mb-2 hidden bg-slate-800 dark:bg-slate-700 text-white text-xs p-2 rounded z-20 whitespace-nowrap shadow-lg left-1/2 -translate-x-1/2 border border-slate-700 dark:border-slate-600">
                                        <div className="font-bold text-center">{currentLabels[index]}</div>
                                        <div className="text-center">{value} {suffix}</div>
                                    </div>
                                    <div style={{ height: `${heightPercentage}%`, minHeight: value > 0 ? '4px' : '0' }} className={`w-full rounded-t-sm ${colorClass} opacity-80 hover:opacity-100 transition-all duration-300 relative`}></div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="flex justify-between mt-2 text-xs text-slate-400 dark:text-slate-500 font-bold px-2">
                        <span>{currentLabels[0]}</span>
                        <span className="hidden md:inline">{currentLabels[Math.floor(currentLabels.length / 2)]}</span>
                        <span>{currentLabels[currentLabels.length - 1]}</span>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (username === 'admin' && password === 'admin123') {
                    onLogin(true);
                    localStorage.setItem('isLoggedIn', 'true');
                } else {
                    setError('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4 relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('images/hero 1.jpg (2).jpg')] bg-cover bg-center opacity-20 blur-sm"></div>
                    <div className="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in relative z-10">
                        <div className="text-center mb-8">
                            <img src="images/logo red.png" alt="Ø´Ø¹Ø§Ø± ØµÙ…Ù‘Ø§Ù…" className="w-40 h-auto mx-auto mb-4 object-contain drop-shadow-xl" onError={(e) => e.target.src='https://via.placeholder.com/150?text=SAMAM'} />
                            <h2 className="text-3xl font-bold text-slate-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none transition bg-slate-50" placeholder="Username" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none transition bg-slate-50" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                            </div>
                            {error && <p className="text-red-600 text-sm text-center font-bold bg-red-100 p-2 rounded border border-red-200">{error}</p>}
                            <button className="w-full bg-orange-600 text-white py-4 rounded-lg font-bold hover:bg-orange-700 transition shadow-lg shadow-orange-500/30 text-lg">Ø¯Ø®ÙˆÙ„</button>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(localStorage.getItem('isLoggedIn') === 'true');
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState("dashboard");
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [loading, setLoading] = useState(true);
            const [isOnline, setIsOnline] = useState(window.navigator.onLine);
            const [connectionError, setConnectionError] = useState(null);
            
            const [darkMode, setDarkMode] = useState(localStorage.getItem('theme') === 'dark');

            useEffect(() => {
                const handleOnline = () => { setIsOnline(true); setConnectionError(null); };
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [darkMode]);

            const toggleTheme = () => { setDarkMode(!darkMode); };
            
            const [unreadCount, setUnreadCount] = useState(0); 
            const [tabNotifications, setTabNotifications] = useState({});
            const [liveNotification, setLiveNotification] = useState(null);
            const notificationAudio = useMemo(() => new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'), []);
            
            const isFirstLoadOrders = useRef(true);
            const isFirstLoadRatings = useRef(true);
            const isFirstLoadMenu = useRef(true);
            const isFirstLoadDiscounts = useRef(true);
            const activeTabRef = useRef(activeTab);

            const [showSecurityModal, setShowSecurityModal] = useState(false);
            const [pendingTab, setPendingTab] = useState(null);
            const [pendingDeleteId, setPendingDeleteId] = useState(null); 
            const SECURITY_PIN = "1234"; 
            const SENSITIVE_TABS = ['history', 'menu', 'site-settings', 'ratings', 'customers'];

            const [orders, setOrders] = useState([]);
            const [menuItems, setMenuItems] = useState([]);
            const [discounts, setDiscounts] = useState([]);
            const [ratings, setRatings] = useState([]);
            const [analytics, setAnalytics] = useState({ total: 0, daily: {}, monthly: {} });
            const [filterCategory, setFilterCategory] = useState("Ø§Ù„ÙƒÙ„");

            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [historyMode, setHistoryMode] = useState('daily'); 
            const [printMode, setPrintMode] = useState('history');

            const [selectedOrder, setSelectedOrder] = useState(null);
            const [selectedRating, setSelectedRating] = useState(null);
            const [downloading, setDownloading] = useState(false);

            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [customerDateFilter, setCustomerDateFilter] = useState('');

            const [siteSettings, setSiteSettings] = useState({
                heroTitle: "Ù…Ø¶ØºÙˆØ· ÙˆØ§ÙƒØ«Ø±",
                heroImage: "images/hero 1.jpg (2).jpg",
                announcement: "",
                showAnnouncement: false,
                announcementBgColor: "#fef3c7",
                announcementTextColor: "#92400e",
                popupImage: "",
                showPopup: false,
                lastClosedAt: null, 
                visitsAtLastClose: 0 
            });

            // Form States
            const [showForm, setShowForm] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [currentItem, setCurrentItem] = useState(null);
            const [formType, setFormType] = useState('item'); // 'item' or 'meal'
            
            const [hasRiceSelection, setHasRiceSelection] = useState(false);
            const [riceTypes, setRiceTypes] = useState([{ name: "Ø±Ø² Ù…Ø²Ù‡ Ø­Ø¨Ø© Ø·ÙˆÙŠÙ„", price: 0 }, { name: "Ø±Ø² Ø¨Ø´Ø§ÙˆØ±", price: 5 }]);
            const [hasSizes, setHasSizes] = useState(false);
            const [sizes, setSizes] = useState([{ name: "Ø­Ø¨Ø© ÙƒØ§Ù…Ù„Ø©", price: 0, plainPrice: 0, ricePrice: 0 }, { name: "Ù†ØµÙ Ø­Ø¨Ø©", price: 0, plainPrice: 0, ricePrice: 0 }]);
            const [hasPlainOption, setHasPlainOption] = useState(false);

            // Meal specific state
            const [mealComponents, setMealComponents] = useState("");
            const [mealHasRice, setMealHasRice] = useState(false);
            // ğŸ”¥ğŸ”¥ Ø§Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© "Ø¨Ø¯ÙˆÙ† Ø§Ø¶Ø§ÙØ§Øª" ğŸ”¥ğŸ”¥
            const [isWithoutAdditions, setIsWithoutAdditions] = useState(false);
            
            // --- ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (Variants) ğŸ”¥ ---
            const [variants, setVariants] = useState([{ name: "", image: "", details: "" }]);
            const [hasVariants, setHasVariants] = useState(false);

            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                return onAuthStateChanged(auth, (u) => setUser(u));
            }, []);

            useEffect(() => {
                activeTabRef.current = activeTab;
                if (activeTab === 'orders') {
                    setUnreadCount(0);
                }
                setTabNotifications(prev => ({...prev, [activeTab]: 0}));
            }, [activeTab]);

            const getOrderDateStr = (timestamp) => {
                if (!timestamp) return "";
                return new Date(timestamp.seconds * 1000).toLocaleDateString('en-CA');
            };

            const customersData = useMemo(() => {
                const custMap = {};
                orders.forEach(order => {
                    const phone = order.phone?.trim() || 'No Phone';
                    if (phone === 'No Phone') return;

                    if (!custMap[phone]) {
                        custMap[phone] = {
                            id: phone, 
                            name: order.customerName,
                            phone: phone,
                            userId: order.userId || null,
                            email: order.userEmail || null, 
                            photo: order.userPhoto || null, 
                            totalOrders: 0,
                            totalSpent: 0,
                            lastOrderDate: order.createdAt || { seconds: 0 },
                            orders: []
                        };
                    }

                    const cust = custMap[phone];
                    cust.totalOrders += 1;
                    cust.totalSpent += parseFloat(order.total) || 0;
                    cust.orders.push(order);
                    
                    if (order.createdAt?.seconds > cust.lastOrderDate.seconds) {
                        cust.lastOrderDate = order.createdAt;
                        cust.name = order.customerName;
                    }
                    
                    if (order.userEmail) cust.email = order.userEmail;
                    if (order.userPhoto) cust.photo = order.userPhoto;
                    if (order.userId) cust.userId = order.userId;
                });

                return Object.values(custMap).sort((a, b) => b.totalSpent - a.totalSpent);
            }, [orders]);

            const filteredCustomers = useMemo(() => {
                let filtered = customersData;
                if (searchQuery) {
                    const lowerQ = searchQuery.toLowerCase();
                    filtered = filtered.filter(c => 
                        c.name.toLowerCase().includes(lowerQ) || 
                        c.phone.includes(lowerQ)
                    );
                }
                if (customerDateFilter) {
                    filtered = filtered.filter(c => {
                        return c.orders.some(o => getOrderDateStr(o.createdAt) === customerDateFilter);
                    });
                }
                return filtered;
            }, [customersData, searchQuery, customerDateFilter]);

            const getCustomerStatus = (orderOrRating, type = 'order') => {
                let count = 0;
                if (type === 'order') {
                    const phone = orderOrRating.phone?.trim();
                    const cust = customersData.find(c => c.phone === phone);
                    count = cust ? cust.totalOrders : 1;
                } else if (type === 'customer') {
                    count = orderOrRating.totalOrders;
                } else {
                     if (orderOrRating.customerId) {
                         const cust = customersData.find(c => c.userId === orderOrRating.customerId);
                         count = cust ? cust.totalOrders : 0;
                     } else if (orderOrRating.phone) {
                         const cust = customersData.find(c => c.phone === orderOrRating.phone);
                         count = cust ? cust.totalOrders : 0;
                     }
                     if (count === 0) return { label: 'Ø²Ø§Ø¦Ø±', class: 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-300' };
                }

                if (count <= 1) return { label: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯', class: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' };
                return { label: 'Ø¹Ù…ÙŠÙ„ Ù…Ù…ÙŠØ²', class: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400' };
            };

            const handleDeleteCustomer = async (customer) => {
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${customer.name}" ÙˆÙƒØ§ÙØ© Ø³Ø¬Ù„Ø§ØªÙ‡ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) return;
                
                setLoading(true);
                try {
                    const promises = customer.orders.map(order => deleteDoc(doc(db, 'orders', order.id)));
                    await Promise.all(promises);
                    if (customer.userId) {
                         const ratingSnap = await getDocs(query(collection(db, 'ratings'), where('customerId', '==', customer.userId)));
                         const ratingPromises = ratingSnap.docs.map(d => deleteDoc(d.ref));
                         await Promise.all(ratingPromises);
                    }
                    alert("ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ³Ø¬Ù„Ù‡ Ø¨Ù†Ø¬Ø§Ø­.");
                    setSelectedCustomer(null);
                } catch (e) {
                    console.error(e);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + e.message);
                }
                setLoading(false);
            };

            useEffect(() => {
                if (!user) return;
                
                const unsubMenu = onSnapshot(collection(db, 'menu'), 
                    (snap) => {
                        const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        items.sort((a, b) => (a.order || 999) - (b.order || 999));
                        setMenuItems(items);

                        if (!isFirstLoadMenu.current) {
                            const changes = snap.docChanges().filter(c => c.type === 'added' || c.type === 'modified');
                            if (changes.length > 0 && activeTabRef.current !== 'menu') {
                                setTabNotifications(prev => ({...prev, menu: (prev.menu || 0) + changes.length}));
                            }
                        }
                        isFirstLoadMenu.current = false;
                        setConnectionError(null);
                    },
                    (error) => {
                        console.error("Menu fetch error:", error);
                        setConnectionError("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²Ù†Ø©.");
                    }
                );
                
                const unsubOrders = onSnapshot(collection(db, 'orders'), 
                    (snap) => {
                        const ords = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        ords.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        
                        if (!isFirstLoadOrders.current) {
                            const addedDocs = snap.docChanges().filter(change => change.type === 'added');
                            if (addedDocs.length > 0) {
                                notificationAudio.play().catch(e => console.log("Audio play failed:", e));
                                if (activeTabRef.current !== 'orders') {
                                    setUnreadCount(prev => prev + addedDocs.length);
                                }
                                if (activeTabRef.current !== 'customers') {
                                    setTabNotifications(prev => ({...prev, customers: (prev.customers || 0) + addedDocs.length}));
                                }
                                const latestOrder = addedDocs[0].doc.data();
                                setLiveNotification({
                                    title: 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸ””',
                                    message: `Ù…Ù†: ${latestOrder.customerName}`,
                                    time: latestOrder.orderDateKSA?.split(',')[1] || 'Ø§Ù„Ø¢Ù†'
                                });
                                setTimeout(() => setLiveNotification(null), 10000);
                            }
                        }
                        isFirstLoadOrders.current = false;
                        setOrders(ords);
                        setConnectionError(null);
                    },
                    (error) => {
                        console.error("Orders fetch error:", error);
                        setConnectionError("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.");
                    }
                );

                const unsubDiscounts = onSnapshot(collection(db, 'discounts'), 
                    (snap) => {
                        setDiscounts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        if (!isFirstLoadDiscounts.current) {
                            const changes = snap.docChanges().filter(c => c.type === 'added');
                            if (changes.length > 0 && activeTabRef.current !== 'discounts') {
                                setTabNotifications(prev => ({...prev, discounts: (prev.discounts || 0) + changes.length}));
                            }
                        }
                        isFirstLoadDiscounts.current = false;
                    },
                    (error) => console.error("Discounts error:", error)
                );
                
                const unsubRatings = onSnapshot(collection(db, 'ratings'), 
                    (snap) => {
                        const rats = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        rats.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        setRatings(rats);
                        if (!isFirstLoadRatings.current) {
                            const changes = snap.docChanges().filter(c => c.type === 'added');
                            if (changes.length > 0 && activeTabRef.current !== 'ratings') {
                                setTabNotifications(prev => ({...prev, ratings: (prev.ratings || 0) + changes.length}));
                            }
                        }
                        isFirstLoadRatings.current = false;
                    },
                    (error) => console.error("Ratings error:", error)
                );

                const unsubAnalytics = onSnapshot(doc(db, 'analytics', 'visitors'), 
                    (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            const daily = {};
                            const monthly = {};
                            Object.keys(data).forEach(key => {
                                if (key.startsWith('daily_')) daily[key.replace('daily_', '')] = data[key];
                                if (key.startsWith('monthly_')) monthly[key.replace('monthly_', '')] = data[key];
                            });
                            setAnalytics({ total: data.total || 0, daily, monthly });
                        }
                    },
                    (error) => console.error("Analytics error:", error)
                );

                const unsubSettings = onSnapshot(doc(db, 'settings', 'general'), 
                    (docSnap) => {
                        if (docSnap.exists()) setSiteSettings(prev => ({...prev, ...docSnap.data()}));
                        setLoading(false);
                    },
                    (error) => {
                        console.error("Settings error:", error);
                        setLoading(false); 
                    }
                );
                return () => { unsubMenu(); unsubOrders(); unsubDiscounts(); unsubAnalytics(); unsubSettings(); unsubRatings(); };
            }, [user]);

            const categories = useMemo(() => {
                const dynamicCats = new Set(menuItems.map(i => i.category));
                const allCats = new Set([...FIXED_CATEGORIES, ...dynamicCats]);
                return ["Ø§Ù„ÙƒÙ„", ...Array.from(allCats)];
            }, [menuItems]);

            const filteredItems = filterCategory === "Ø§Ù„ÙƒÙ„" 
                ? menuItems 
                : menuItems.filter(i => i.category === filterCategory);

            const todayStr = new Date().toLocaleDateString('en-CA'); 
            const currentDayStats = useMemo(() => {
                const visits = analytics.daily[todayStr] || 0;
                const todayOrders = orders.filter(o => getOrderDateStr(o.createdAt) === todayStr);
                const revenue = todayOrders.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);
                return { visits, orders: todayOrders.length, revenue };
            }, [orders, analytics, todayStr]);

            const chartData = useMemo(() => {
                const getLastDays = (days) => {
                    const result = [];
                    for (let i = days - 1; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        result.push(d.toISOString().split('T')[0]);
                    }
                    return result;
                };

                const last7Days = getLastDays(7);
                const salesLast7Days = last7Days.map(date => {
                    return orders
                        .filter(o => getOrderDateStr(o.createdAt) === date)
                        .reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);
                });
                const visitsLast7Days = last7Days.map(date => analytics.daily[date] || 0);

                const last30Days = getLastDays(30);
                const salesLast30Days = last30Days.map(date => {
                    return orders
                        .filter(o => getOrderDateStr(o.createdAt) === date)
                        .reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);
                });
                const visitsLast30Days = last30Days.map(date => analytics.daily[date] || 0);

                return {
                    labels7: last7Days,
                    sales7: salesLast7Days,
                    visits7: visitsLast7Days,
                    labels30: last30Days,
                    sales30: salesLast30Days,
                    visits30: visitsLast30Days
                };
            }, [orders, analytics.daily]);

            const historyStats = useMemo(() => {
                let filteredOrders = [];
                let visitsCount = 0;
                let totalRevenue = 0;

                if (historyMode === 'daily') {
                    if (!selectedDate) return { orders: [], revenue: 0, visits: 0 };
                    filteredOrders = orders.filter(o => getOrderDateStr(o.createdAt) === selectedDate);
                    visitsCount = analytics.daily[selectedDate] || 0;
                } else {
                    const selectedMonth = selectedDate.slice(0, 7); 
                    filteredOrders = orders.filter(o => getOrderDateStr(o.createdAt).startsWith(selectedMonth));
                    visitsCount = analytics.monthly[selectedMonth] || 0;
                }

                totalRevenue = filteredOrders.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);
                return { orders: filteredOrders, revenue: totalRevenue, visits: visitsCount };
            }, [orders, analytics, selectedDate, historyMode]);

            const handleCloseDay = async () => {
                if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ØŸ (Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø­ÙØ¸ Ù†Ù‚Ø·Ø© Ù…Ø±Ø¬Ø¹ÙŠØ© ÙÙ‚Ø·)")) return;
                try {
                    await updateDoc(doc(db, 'settings', 'general'), {
                        lastClosedAt: serverTimestamp(), 
                        visitsAtLastClose: analytics.total 
                    });
                    alert("ØªÙ… Ø­ÙØ¸ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¨Ù†Ø¬Ø§Ø­!");
                } catch (e) {
                    alert("Ø®Ø·Ø£: " + e.message);
                }
            };

            const handleDeleteOrder = (id) => {
                setPendingTab(null);
                setPendingDeleteId(id);
                setShowSecurityModal(true);
            };

            const handleDeleteRating = async (id) => {
                if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ")) {
                    try {
                        await deleteDoc(doc(db, 'ratings', id));
                    } catch (e) {
                        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + e.message);
                    }
                }
            };
            
            const handleDownloadCard = () => {
                const element = document.getElementById('shareableCard');
                if (!element) return;
                setDownloading(true);
                html2canvas(element, { scale: 2, backgroundColor: '#ffffff', useCORS: true }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `rating_${selectedRating.id}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    setDownloading(false);
                }).catch(err => {
                    console.error("Download failed:", err);
                    alert("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©");
                    setDownloading(false);
                });
            };

            const handleApplyGlobalDiscount = async () => {
                const discountVal = prompt("Ø£Ø¯Ø®Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù (Ù…Ø«Ù„Ø§Ù‹ 20)\nØ£Ø¯Ø®Ù„ 0 Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø®ØµÙ…");
                if (discountVal === null) return;
                const percent = parseInt(discountVal);
                if (isNaN(percent) || percent < 0 || percent > 100) return alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø®ØµÙ… ${percent}% Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§ÙØŸ`)) return;

                setLoading(true);
                try {
                    const snap = await getDocs(collection(db, 'menu'));
                    const batch = writeBatch(db);
                    snap.forEach(doc => { batch.update(doc.ref, { discount: percent }); });
                    await batch.commit();
                    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                } catch (e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message); }
                setLoading(false);
            };

            const handleNavClick = (tabId) => {
                setPendingDeleteId(null);
                if (SENSITIVE_TABS.includes(tabId)) {
                    setPendingTab(tabId);
                    setShowSecurityModal(true);
                } else {
                    setActiveTab(tabId);
                    if(window.innerWidth < 768) setSidebarOpen(false);
                }
            };

            const handleSecurityCheck = async (e) => {
                e.preventDefault();
                const pin = e.target.pin.value;
                if (pin === SECURITY_PIN) {
                    if (pendingDeleteId) {
                        try {
                            await deleteDoc(doc(db, 'orders', pendingDeleteId));
                            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
                        } catch (e) { alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + e.message); }
                        setPendingDeleteId(null);
                    } else if (pendingTab) {
                        setActiveTab(pendingTab);
                        setPendingTab(null);
                        if(window.innerWidth < 768) setSidebarOpen(false);
                    }
                    setShowSecurityModal(false);
                } else {
                    alert("Ø±Ù…Ø² Ø§Ù„Ø­Ù…Ø§ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­!");
                    e.target.reset();
                }
            };

            const addRiceType = () => setRiceTypes([...riceTypes, { name: "", price: 0 }]);
            const updateRiceName = (idx, val) => { const n = [...riceTypes]; n[idx].name = val; setRiceTypes(n); };
            const updateRicePrice = (idx, val) => { const n = [...riceTypes]; n[idx].price = parseFloat(val) || 0; setRiceTypes(n); };
            const removeRiceType = (idx) => setRiceTypes(riceTypes.filter((_, i) => i !== idx));

            const addSize = () => setSizes([...sizes, { name: "", price: 0, plainPrice: 0, ricePrice: 0 }]);
            const updateSizeName = (idx, val) => { const n = [...sizes]; n[idx].name = val; setSizes(n); };
            const updateSizePrice = (idx, val) => { const n = [...sizes]; n[idx].price = parseFloat(val) || 0; setSizes(n); };
            const updateSizePlainPrice = (idx, val) => { const n = [...sizes]; n[idx].plainPrice = parseFloat(val) || 0; setSizes(n); };
            const updateSizeRicePrice = (idx, val) => { const n = [...sizes]; n[idx].ricePrice = parseFloat(val) || 0; setSizes(n); };
            const removeSize = (idx) => setSizes(sizes.filter((_, i) => i !== idx));

            // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (Variants) ---
            const addVariant = () => setVariants([...variants, { name: "", image: "", details: "" }]);
            const updateVariantName = (idx, val) => { const v = [...variants]; v[idx].name = val; setVariants(v); };
            const updateVariantImage = (idx, val) => { const v = [...variants]; v[idx].image = val; setVariants(v); };
            const updateVariantDetails = (idx, val) => { const v = [...variants]; v[idx].details = val; setVariants(v); };
            const removeVariant = (idx) => setVariants(variants.filter((_, i) => i !== idx));

            const handleSaveItem = async (e) => {
                e.preventDefault();
                const form = new FormData(e.target);
                
                let data = {};
                
                if (formType === 'meal') {
                    // Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©
                    data = {
                        name: form.get('name'),
                        price: parseFloat(form.get('price')) || 0,
                        order: parseInt(form.get('order')) || 999,
                        discount: parseInt(form.get('discount')) || 0,
                        category: form.get('category'),
                        image: form.get('image'),
                        calories: form.get('calories'),
                        type: 'meal', // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ ÙƒÙˆØ¬Ø¨Ø©
                        components: mealComponents, // Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ÙƒÙ†Øµ
                        hasRice: mealHasRice, // Ù‡Ù„ ØªØ´Ù…Ù„ Ø§Ù„Ø±Ø²ØŸ
                        hasVariants: hasVariants, // Ù‡Ù„ Ù„Ø¯ÙŠÙ‡Ø§ Ø£Ù†ÙˆØ§Ø¹ØŸ
                        variants: hasVariants ? variants : [], // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
                        // ğŸ”¥ğŸ”¥ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ§Øª ğŸ”¥ğŸ”¥
                        isWithoutAdditions: isWithoutAdditions,
                        status: form.get('status'),
                        updatedAt: serverTimestamp()
                    };
                } else {
                    // Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø§Ù„Ù‚Ø¯ÙŠÙ…)
                    let basePrice = parseFloat(form.get('price')) || 0;
                    if (hasSizes && sizes.length > 0) {
                        basePrice = hasPlainOption ? sizes[0].ricePrice : sizes[0].price;
                    }
                    data = {
                        name: form.get('name'),
                        price: basePrice, 
                        order: parseInt(form.get('order')) || 999,
                        discount: parseInt(form.get('discount')) || 0,
                        category: form.get('category'),
                        image: form.get('image'),
                        calories: form.get('calories'),
                        prepTimeType: form.get('prepTimeType'),
                        prepTimeValue: form.get('prepTimeValue'),
                        type: 'item', // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ ÙƒØµÙ†Ù Ø¹Ø§Ø¯ÙŠ
                        hasRiceSelection: hasRiceSelection,
                        riceTypes: hasRiceSelection ? riceTypes : [],
                        hasSizes: hasSizes,
                        hasPlainOption: hasPlainOption,
                        sizes: hasSizes ? sizes : [],
                        status: form.get('status'),
                        updatedAt: serverTimestamp()
                    };
                }

                try {
                    if (isEditing) await updateDoc(doc(db, 'menu', currentItem.id), data);
                    else await addDoc(collection(db, 'menu'), { ...data, createdAt: serverTimestamp() });
                    setShowForm(false);
                } catch(e) { alert("Ø®Ø·Ø£: " + e.message); }
            };

            const handleSaveDiscount = async (e) => {
                e.preventDefault();
                const form = new FormData(e.target);
                const data = {
                    code: form.get('code').toUpperCase(),
                    value: parseFloat(form.get('value')) / 100,
                    perUserLimit: parseInt(form.get('perUserLimit')) || 1,
                    active: true,
                    createdAt: serverTimestamp()
                };
                try {
                    await addDoc(collection(db, 'discounts'), data);
                    setShowForm(false);
                    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­");
                } catch(e) { alert("Ø®Ø·Ø£: " + e.message); }
            };

            const handleDeleteItem = async (id) => { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db, 'menu', id)); };
            const handleDeleteDiscount = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ØŸ")) await deleteDoc(doc(db, 'discounts', id)); };
            const handleSaveSettings = async (e) => { e.preventDefault(); await setDoc(doc(db, 'settings', 'general'), siteSettings); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!"); };
            const toggleOrderStatus = async (o) => { const map = {'Ø¬Ø¯ÙŠØ¯':'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±':'Ù…ÙƒØªÙ…Ù„', 'Ù…ÙƒØªÙ…Ù„':'Ù…ÙƒØªÙ…Ù„'}; await updateDoc(doc(db, 'orders', o.id), { status: map[o.status] }); };

            const openForm = (item = null, type = 'item') => {
                setFormType(type); // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ÙÙˆØ±Ù… (ØµÙ†Ù Ø¹Ø§Ø¯ÙŠ Ø§Ùˆ ÙˆØ¬Ø¨Ø©)
                
                if (item) {
                    setCurrentItem(item);
                    setIsEditing(true);
                    setFormType(item.type || 'item'); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    
                    if (item.type === 'meal') {
                        setMealComponents(item.components || "");
                        setMealHasRice(item.hasRice || false);
                        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ÙˆØ¬Ø¨Ø©
                        setHasVariants(item.hasVariants || (item.variants && item.variants.length > 0) || false);
                        setVariants(item.variants && item.variants.length > 0 ? item.variants : [{ name: "", image: "", details: "" }]);
                        // ğŸ”¥ğŸ”¥ ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ§Øª ğŸ”¥ğŸ”¥
                        setIsWithoutAdditions(item.isWithoutAdditions || false);
                    } else {
                        setHasRiceSelection(item.hasRiceSelection || item.hasRiceOptions || false);
                        setRiceTypes(item.riceTypes && item.riceTypes.length > 0 ? (typeof item.riceTypes[0] === 'string' ? item.riceTypes.map(r => ({name: r, price: 0})) : item.riceTypes) : [{ name: "Ø±Ø² Ù…Ø²Ù‡ Ø­Ø¨Ø© Ø·ÙˆÙŠÙ„", price: 0 }]);
                        setHasSizes(item.hasSizes || false);
                        setHasPlainOption(item.hasPlainOption || false);
                        setSizes(item.sizes && item.sizes.length > 0 ? item.sizes : [{ name: "Ø­Ø¨Ø© ÙƒØ§Ù…Ù„Ø©", price: 0, plainPrice: 0, ricePrice: 0 }]);
                    }
                } else {
                    setCurrentItem(null);
                    setIsEditing(false);
                    
                    // Reset fields based on type
                    if (type === 'meal') {
                        setMealComponents("");
                        setMealHasRice(false);
                        setHasVariants(false);
                        setVariants([{ name: "", image: "", details: "" }]);
                        setIsWithoutAdditions(false);
                    } else {
                        setHasRiceSelection(false);
                        setRiceTypes([{ name: "Ø±Ø² Ù…Ø²Ù‡ Ø­Ø¨Ø© Ø·ÙˆÙŠÙ„", price: 0 }]);
                        setHasSizes(false);
                        setHasPlainOption(false);
                        setSizes([{ name: "Ø­Ø¨Ø© ÙƒØ§Ù…Ù„Ø©", price: 0, plainPrice: 0, ricePrice: 0 }]);
                    }
                }
                setShowForm(true);
            };

            const handleLogout = () => { localStorage.removeItem('isLoggedIn'); setIsLoggedIn(false); };
            
            const handlePrintReport = (mode) => {
                setPrintMode(mode);
                setTimeout(() => window.print(), 100);
            };

            const handlePrintOrder = () => {
                if (!selectedOrder) return;
                const itemsHtml = selectedOrder.itemsString.split('\n').filter(line => line.trim() && !line.includes('-----')).map(line => `
                    <tr>
                        <td style="padding: 5px 0; border-bottom: 1px dotted #ccc;">${line}</td>
                    </tr>
                `).join('');

                const printContent = `
                    <div style="direction: rtl; font-family: 'Cairo', sans-serif; padding: 10px; max-width: 300px; margin: 0 auto; color: #000;">
                        <div style="text-align: center; border-bottom: 2px dashed #333; padding-bottom: 10px; margin-bottom: 10px;">
                            <img src="images/logo red.png" style="width: 80px; display: block; margin: 0 auto 5px auto;" />
                            <h2 style="margin: 0; font-size: 18px; font-weight: 800;">Ù…Ø·Ø¹Ù… ØµÙ…Ù‘Ø§Ù…</h2>
                            <p style="margin: 2px 0; font-size: 12px;">ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©</p>
                        </div>
                        
                        <div style="font-size: 12px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;"><span>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span> <span style="font-weight: bold;">#${String(selectedOrder.createdAt?.seconds || '').slice(-4)}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span>Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span>${selectedOrder.orderDateKSA}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span>Ø§Ù„Ø¹Ù…ÙŠÙ„:</span> <span>${selectedOrder.customerName}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span>Ø§Ù„Ø¬ÙˆØ§Ù„:</span> <span>${selectedOrder.phone}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span>Ø§Ù„ØªÙˆØµÙŠÙ„:</span> <span>${selectedOrder.deliveryType}</span></div>
                        </div>

                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 10px;">
                            <thead>
                                <tr>
                                    <th style="text-align: right; border-bottom: 1px solid #000; padding-bottom: 5px;">Ø§Ù„ØµÙ†Ù / Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>

                        <div style="border-top: 2px dashed #333; padding-top: 10px; margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; font-size: 16px; font-weight: bold;">
                                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                                <span>${selectedOrder.total} Ø±.Ø³</span>
                            </div>
                            <p style="text-align: center; margin-top: 5px; font-size: 12px;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${selectedOrder.paymentType}</p>
                        </div>

                        <div style="text-align: center; margin-top: 20px; font-size: 10px; border-top: 1px solid #eee; padding-top: 5px;">
                            <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…! Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… ÙˆØ¬Ø¨Ø© Ø´Ù‡ÙŠØ©</p>
                        </div>
                    </div>
                `;
                const printWindow = window.open('', '', 'width=400,height=600');
                printWindow.document.write('<html><head><title>ÙØ§ØªÙˆØ±Ø© ØµÙ…Ù‘Ø§Ù…</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"><style>body{margin:0;padding:0;background-color:#fff;} @media print { body { -webkit-print-color-adjust: exact; } }</style></head><body' + '>');
                printWindow.document.write(printContent);
                printWindow.document.write('</body' + '></html>');
                printWindow.document.close();
                printWindow.print();
            };

            const handlePrintCustomerFile = () => {
                if (!selectedCustomer) return;
                const printContent = `<div style="direction: rtl; font-family: 'Cairo', sans-serif; padding: 20px; text-align: center;"><img src="images/logo red.png" style="width: 120px; margin-bottom: 20px;" /><h2 style="margin-bottom: 5px;">Ù…Ù„Ù Ø§Ù„Ø¹Ù…ÙŠÙ„</h2><h1 style="font-size: 28px; margin: 10px 0;">${selectedCustomer.name}</h1><p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> ${selectedCustomer.phone}</p><div style="display: flex; justify-content: space-around; margin: 20px 0; border: 1px solid #000; padding: 10px;"><div><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</strong> ${selectedCustomer.totalOrders}</div><div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚:</strong> ${selectedCustomer.totalSpent.toFixed(1)} Ø±.Ø³</div></div><table style="width: 100%; border-collapse: collapse; margin-top: 20px;"><thead><tr style="background: #f0f0f0;"><th style="border: 1px solid #000; padding: 8px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th style="border: 1px solid #000; padding: 8px;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th style="border: 1px solid #000; padding: 8px;">Ø§Ù„Ù…Ø¨Ù„Øº</th><th style="border: 1px solid #000; padding: 8px;">Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${selectedCustomer.orders.map(o => `<tr><td style="border: 1px solid #000; padding: 8px;">${o.orderDateKSA || '-'}</td><td style="border: 1px solid #000; padding: 8px;">#${String(o.createdAt?.seconds || '').slice(-4)}</td><td style="border: 1px solid #000; padding: 8px;">${o.total} Ø±.Ø³</td><td style="border: 1px solid #000; padding: 8px;">${o.status}</td></tr>`).join('')}</tbody></table></div>`;
                const printWindow = window.open('', '', 'width=800,height=900');
                printWindow.document.write('<html><head><title>Ù…Ù„Ù Ø§Ù„Ø¹Ù…ÙŠÙ„</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"><style>body{margin:0;}</style></head><body' + '>');
                printWindow.document.write(printContent);
                printWindow.document.write('</body' + '></html>');
                printWindow.document.close();
                printWindow.print();
            };

            if (!isLoggedIn) return <LoginScreen onLogin={setIsLoggedIn} />;
            if (loading) return <div className="h-screen flex items-center justify-center dark:bg-slate-900"><Loader2 className="animate-spin text-orange-600 w-10 h-10"/></div>;
            
            const currentMonth = new Date().toLocaleDateString('en-CA').slice(0, 7);
            const monthlyVisits = analytics.monthly[currentMonth] || 0;

            return (
    <div className="flex min-h-screen">
        {/* ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ */}
        <div className="print-only print-container">
            <div className="print-header">
                <img src="images/logo red.png" alt="Ø´Ø¹Ø§Ø± ØµÙ…Ù‘Ø§Ù…" style={{width: '100px', margin: '0 auto'}} />
                <h1 style={{fontSize: '24px', fontWeight: 'bold', margin: '10px 0'}}>
                    {printMode === 'history' ? 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª' : 'ØªÙ‚Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡'}
                </h1>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {new Date().toLocaleDateString('ar-EG')}</p>
                {printMode === 'history' && <p>Ø¹Ù† ÙŠÙˆÙ…: {selectedDate}</p>}
                {printMode === 'customers' && customerDateFilter && <p>ÙÙ„ØªØ±Ø© Ø¨ØªØ§Ø±ÙŠØ®: {customerDateFilter}</p>}
            </div>

            {printMode === 'history' ? (
                <>
                    <div style={{border: '1px solid #000', padding: '10px', marginBottom: '20px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '18px', fontWeight: 'bold'}}>
                            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: {historyStats.revenue} Ø±.Ø³</span>
                            <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: {historyStats.orders.length}</span>
                        </div>
                    </div>
                    <table style={{width: '100%', borderCollapse: 'collapse', textAlign: 'right'}}>
                        <thead>
                            <tr style={{background: '#f0f0f0'}}>
                                <th style={{border: '1px solid #000', padding: '5px'}}>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                                <th style={{border: '1px solid #000', padding: '5px'}}>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th style={{border: '1px solid #000', padding: '5px'}}>Ø§Ù„ÙˆÙ‚Øª</th>
                                <th style={{border: '1px solid #000', padding: '5px'}}>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {historyStats.orders.map((o, i) => (
                                <tr key={i}>
                                    <td style={{border: '1px solid #000', padding: '5px'}}>#{String(o.createdAt?.seconds).slice(-4)}</td>
                                    <td style={{border: '1px solid #000', padding: '5px'}}>
                                        {o.customerName}<br/>
                                        <small>{o.phone}</small>
                                    </td>
                                    <td style={{border: '1px solid #000', padding: '5px'}} dir="ltr" className="text-right">
                                        {o.orderDateKSA || (o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleTimeString('ar-EG') : '-')}
                                    </td>
                                    <td style={{border: '1px solid #000', padding: '5px'}}>{o.total} Ø±.Ø³</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </>
            ) : (
                <table style={{width: '100%', borderCollapse: 'collapse', textAlign: 'right'}}>
                    <thead>
                        <tr style={{background: '#f0f0f0'}}>
                            <th style={{border: '1px solid #000', padding: '5px'}}>Ø§Ù„Ø§Ø³Ù…</th>
                            <th style={{border: '1px solid #000', padding: '5px'}}>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                            <th style={{border: '1px solid #000', padding: '5px'}}>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                            <th style={{border: '1px solid #000', padding: '5px'}}>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚</th>
                            <th style={{border: '1px solid #000', padding: '5px'}}>Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredCustomers.map((c, i) => (
                            <tr key={i}>
                                <td style={{border: '1px solid #000', padding: '5px'}}>{c.name}</td>
                                <td style={{border: '1px solid #000', padding: '5px', direction: 'ltr', textAlign: 'right'}}>{c.phone}</td>
                                <td style={{border: '1px solid #000', padding: '5px'}}>{c.totalOrders}</td>
                                <td style={{border: '1px solid #000', padding: '5px'}}>{c.totalSpent} Ø±.Ø³</td>
                                <td style={{border: '1px solid #000', padding: '5px'}}>
                                    {c.lastOrderDate?.seconds ? new Date(c.lastOrderDate.seconds * 1000).toLocaleDateString('en-CA') : '-'}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            )}
        </div>

        <aside className={`fixed md:static w-64 bg-slate-900 text-white h-full z-20 transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : 'translate-x-full md:translate-x-0'} no-print`}>
            <div className="p-6 border-b border-slate-700 font-bold text-xl flex gap-3 items-center justify-center text-orange-500">
                 <img src="images/logo p.png" className="w-32 h-auto object-contain" onError={(e) => e.target.style.display = 'none'} />
            </div>
            <nav className="p-4 space-y-2 flex-1">
                {[
                    {id:'dashboard',icon:LayoutDashboard,l:'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', restricted: false},
                    {id:'orders',icon:ShoppingBag,l:'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©', restricted: false},
                    {id:'customers',icon:Users,l:'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', restricted: true},
                    {id:'discounts',icon:Tag,l:'Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…', restricted: false},
                    {id:'history',icon:Calendar,l:'Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª', restricted: true},
                    {id:'ratings',icon:Star,l:'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª', restricted: true},
                    {id:'menu',icon:Menu,l:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ', restricted: true},
                    {id:'site-settings',icon:Settings,l:'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹', restricted: true}
                ].map(i=>(
                    <button key={i.id} onClick={()=>handleNavClick(i.id)} className={`w-full flex gap-3 p-3 rounded items-center ${activeTab===i.id?'bg-orange-600':'hover:bg-slate-800'} ${i.restricted ? 'justify-between' : ''} relative`}>
                        <div className="flex gap-3 items-center"><i.icon size={20}/> <span>{i.l}</span></div>
                        
                        {i.id === 'orders' && unreadCount > 0 && (
                            <span className="absolute left-10 top-1/2 -translate-y-1/2 bg-red-600 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center pulse-badge">
                                {unreadCount}
                            </span>
                        )}

                        {i.id !== 'orders' && tabNotifications[i.id] > 0 && (
                            <span className="absolute left-10 top-1/2 -translate-y-1/2 bg-red-600 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center pulse-badge">
                                {tabNotifications[i.id]}
                            </span>
                        )}

                        {i.restricted && <Lock size={14} className="text-slate-500" />}
                    </button>
                ))}
            </nav>
            <div className="p-4 border-t border-slate-700 space-y-2">
                <button onClick={toggleTheme} className="w-full flex gap-3 p-3 rounded text-slate-300 hover:bg-slate-800 hover:text-white transition">
                    {darkMode ? <Sun size={20} className="text-yellow-400"/> : <Moon size={20}/>}
                    <span>{darkMode ? "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ" : "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ"}</span>
                </button>
                <button onClick={handleLogout} className="w-full flex gap-3 p-3 rounded text-red-400 hover:bg-slate-800 hover:text-red-300 transition"><LogOut size={20}/> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main className="flex-1 flex flex-col h-screen overflow-hidden no-print">
            <header className="h-16 border-b dark:border-slate-700 bg-white dark:bg-slate-800 flex items-center justify-between px-4 md:px-6 shadow-sm z-10 transition-colors">
                <div className="flex items-center gap-4">
                    <button onClick={()=>setSidebarOpen(!sidebarOpen)} className="md:hidden dark:text-white"><Menu/></button>
                    <h2 className="font-bold text-lg dark:text-white">{activeTab === 'customers' ? 'Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' : activeTab === 'ratings' ? 'ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' : activeTab === 'history' ? 'Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' : activeTab === 'menu' ? 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©' : 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…'}</h2>
                </div>
                
                <div className="flex gap-2">
                    {connectionError && (
                        <div className="hidden sm:flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400 animate-pulse">
                            <Database size={14} />
                            <span>ÙˆØ¶Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ</span>
                        </div>
                    )}
                    <div className={`flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold transition-colors ${isOnline ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'}`}>
                        {isOnline ? <Wifi size={14} className="animate-pulse"/> : <WifiOff size={14}/>}
                        <span className="hidden sm:inline">{isOnline ? 'Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹' : 'ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„'}</span>
                    </div>
                </div>
            </header>
            
            <div className="flex-1 overflow-auto p-4 md:p-6 bg-slate-50 dark:bg-slate-900 transition-colors">
                
                {activeTab === 'dashboard' && (
                    <div className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white shadow-lg">
                                <div className="flex justify-between items-start mb-4"><div className="p-2 bg-white/20 rounded-lg"><Users size={24}/></div><span className="text-xs bg-white/20 px-2 py-1 rounded">Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span></div>
                                <p className="text-sm text-blue-100">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ… - {todayStr}</p><p className="text-3xl font-bold">{currentDayStats.visits}</p>
                            </div>
                            <div className="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl text-white shadow-lg">
                                <div className="flex justify-between items-start mb-4"><div className="p-2 bg-white/20 rounded-lg"><BarChart3 size={24}/></div><span className="text-xs bg-white/20 px-2 py-1 rounded">Ø§Ù„Ø´Ù‡Ø±</span></div>
                                <p className="text-sm text-purple-100">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø±</p><p className="text-3xl font-bold">{monthlyVisits}</p>
                            </div>
                            <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-xl text-white shadow-lg">
                                <div className="flex justify-between items-start mb-4"><div className="p-2 bg-white/20 rounded-lg"><TrendingUp size={24}/></div><span className="text-xs bg-white/20 px-2 py-1 rounded">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span></div>
                                <p className="text-sm text-emerald-100">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</p><p className="text-3xl font-bold">{analytics.total}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <ToggleableChart 
                                title="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª" 
                                data7={chartData.sales7} 
                                labels7={chartData.labels7} 
                                data30={chartData.sales30} 
                                labels30={chartData.labels30}
                                colorClass="bg-emerald-500" 
                                suffix="Ø±.Ø³"
                            />
                            <ToggleableChart 
                                title="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª" 
                                data7={chartData.visits7} 
                                labels7={chartData.labels7} 
                                data30={chartData.visits30} 
                                labels30={chartData.labels30}
                                colorClass="bg-blue-500" 
                            />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm transition-colors"><p className="text-gray-500 dark:text-slate-400">Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ù†ÙŠÙˆ</p><p className="text-3xl font-bold dark:text-white">{menuItems.length}</p></div>
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm transition-colors"><p className="text-gray-500 dark:text-slate-400">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p><p className="text-3xl font-bold text-blue-600 dark:text-blue-400">{currentDayStats.orders}</p></div>
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm transition-colors"><p className="text-gray-500 dark:text-slate-400">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p><p className="text-3xl font-bold text-green-600 dark:text-green-400">{currentDayStats.revenue.toFixed(1)} Ø±.Ø³</p></div>
                        </div>
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-wrap gap-4 justify-between items-center transition-colors">
                            <div><h3 className="text-xl font-bold text-slate-800 dark:text-white mb-1">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3><p className="text-slate-500 dark:text-slate-400 text-sm">ØªØªØ¬Ø¯Ø¯ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p></div>
                            <div className="flex gap-2">
                                <button onClick={() => { setSelectedDate(new Date().toISOString().split('T')[0]); handleNavClick('history'); }} className="bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 px-4 py-3 rounded-lg font-bold flex gap-2 items-center"><FileText size={18}/> Ø§Ù„Ø³Ø¬Ù„</button>
                                <button onClick={handleCloseDay} className="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold flex gap-2 items-center"><RefreshCw size={18}/> Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ… (ÙŠØ¯ÙˆÙŠ)</button>
                            </div>
                        </div>
                    </div>
                )}
                
                {activeTab === 'history' && (
                    <div className="space-y-6">
                        <div className="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col md:flex-row flex-wrap gap-4 items-start md:items-end justify-between transition-colors">
                            <div className="w-full md:w-auto">
                                <div className="flex gap-2 mb-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg w-fit">
                                    <button onClick={() => setHistoryMode('daily')} className={`px-4 py-1 rounded-md text-sm font-bold transition ${historyMode === 'daily' ? 'bg-white dark:bg-slate-600 shadow text-slate-800 dark:text-white' : 'text-slate-500'}`}>ÙŠÙˆÙ…ÙŠ</button>
                                    <button onClick={() => setHistoryMode('monthly')} className={`px-4 py-1 rounded-md text-sm font-bold transition ${historyMode === 'monthly' ? 'bg-white dark:bg-slate-600 shadow text-slate-800 dark:text-white' : 'text-slate-500'}`}>Ø´Ù‡Ø±ÙŠ</button>
                                </div>
                                <label className="block text-sm font-bold text-gray-700 dark:text-slate-300 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¬Ù„</label>
                                <input type={historyMode === 'daily' ? 'date' : 'month'} value={historyMode === 'daily' ? selectedDate : selectedDate.slice(0, 7)} onChange={(e) => setSelectedDate(e.target.value)} className="p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-700 text-lg font-bold w-full dark:text-white"/>
                            </div>
                            <div className="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                                <div className="text-center px-6 py-2 bg-purple-50 dark:bg-purple-900/30 rounded-lg border border-purple-100 dark:border-purple-800">
                                    <p className="text-xs text-gray-500 dark:text-slate-400">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</p>
                                    <p className="text-xl font-bold text-purple-700 dark:text-purple-400">{historyStats.visits}</p>
                                </div>
                                <div className="text-center px-6 py-2 bg-green-50 dark:bg-green-900/30 rounded-lg border border-green-100 dark:border-green-800">
                                    <p className="text-xs text-gray-500 dark:text-slate-400">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
                                    <p className="text-xl font-bold text-green-700 dark:text-green-400">{historyStats.revenue.toFixed(1)} Ø±.Ø³</p>
                                </div>
                                <div className="text-center px-6 py-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg border border-blue-100 dark:border-blue-800">
                                    <p className="text-xs text-gray-500 dark:text-slate-400">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                                    <p className="text-xl font-bold text-blue-700 dark:text-blue-400">{historyStats.orders.length}</p>
                                </div>
                                <button onClick={() => handlePrintReport('history')} className="bg-slate-800 dark:bg-slate-600 text-white px-4 py-2 rounded-lg flex gap-2 items-center hover:bg-slate-700 dark:hover:bg-slate-500 w-full md:w-auto">
                                    <Printer size={18}/> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                        </div>
                        <div className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm overflow-x-auto transition-colors">
                            <table className="w-full text-right text-sm min-w-[600px]">
                                <thead className="bg-slate-5 dark:bg-slate-700 text-gray-500 dark:text-slate-300">
                                    <tr>
                                        <th className="p-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                        <th className="p-4">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                                        <th className="p-4">Ø§Ù„ÙˆÙ‚Øª</th>
                                        <th className="p-4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                        <th className="p-4">Ø¥Ø¬Ø±Ø§Ø¡</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                                    {historyStats.orders.map(o => (
                                        <tr key={o.id} className="hover:bg-slate-5 dark:hover:bg-slate-700 cursor-pointer transition-colors" onClick={() => setSelectedOrder(o)}>
                                            <td className="p-4 font-bold dark:text-white">
                                                {o.customerName}<br/>
                                                <span className="text-xs text-gray-400 dark:text-slate-500 font-normal">{o.phone}</span>
                                            </td>
                                            <td className="p-4 text-xs max-w-xs dark:text-slate-300">{o.itemsString}</td>
                                            <td className="p-4 text-xs dark:text-slate-300">{o.orderDateKSA ? (o.orderDateKSA.includes(',') ? o.orderDateKSA.split(',')[1] : o.orderDateKSA) : '-'}</td>
                                            <td className="p-4 font-bold text-green-600 dark:text-green-400">{o.total} Ø±.Ø³</td>
                                            <td className="p-4">
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); handleDeleteOrder(o.id); }} 
                                                    className="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 py-1 rounded text-xs hover:bg-red-200 dark:hover:bg-red-900/50"
                                                >
                                                    Ø­Ø°Ù
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {activeTab === 'customers' && (
                    <div className="space-y-6">
                        <div className="flex flex-col md:flex-row gap-4 items-center bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <div className="flex-1 flex items-center w-full">
                                <Search className="text-gray-400 ml-2 flex-shrink-0" size={20}/>
                                <input 
                                    type="text" 
                                    placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„..." 
                                    className="bg-transparent border-none outline-none w-full text-slate-700 dark:text-slate-200"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                />
                            </div>
                            <div className="flex gap-2 items-center w-full md:w-auto border-t md:border-t-0 md:border-r border-slate-100 dark:border-slate-700 pt-2 md:pt-0 md:pr-4">
                                <div className="flex items-center gap-2">
                                    <Filter size={18} className="text-gray-400"/>
                                    <input 
                                        type="date" 
                                        className="bg-transparent border border-slate-200 dark:border-slate-600 rounded px-2 py-1 text-sm dark:text-slate-200"
                                        value={customerDateFilter}
                                        onChange={(e) => setCustomerDateFilter(e.target.value)}
                                        title="ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ ÙŠÙˆÙ… Ø§Ù„Ø·Ù„Ø¨"
                                    />
                                    {customerDateFilter && <button onClick={() => setCustomerDateFilter('')} className="text-xs text-red-500 hover:underline">Ù…Ø³Ø­</button>}
                                </div>
                                <button onClick={() => handlePrintReport('customers')} className="bg-slate-800 dark:bg-slate-600 text-white px-3 py-2 rounded flex gap-2 items-center text-sm font-bold hover:bg-slate-700">
                                    <Printer size={16}/> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                                </button>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm transition-colors">
                            <table className="w-full text-right text-sm">
                                <thead className="bg-slate-5 dark:bg-slate-700 text-gray-500 dark:text-slate-300">
                                    <tr>
                                        <th className="p-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                        <th className="p-4">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                                        <th className="p-4">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                                        <th className="p-4">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚</th>
                                        <th className="p-4">Ø¢Ø®Ø± Ø·Ù„Ø¨</th>
                                        <th className="p-4">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                                    {filteredCustomers.map(c => {
                                        const status = getCustomerStatus(c, 'customer');
                                        return (
                                            <tr key={c.id} className="hover:bg-slate-5 dark:hover:bg-slate-700 transition-colors cursor-pointer" onClick={() => setSelectedCustomer(c)}>
                                                <td className="p-4 font-bold dark:text-white flex items-center gap-2">
                                                    {c.photo ? (
                                                        <img src={c.photo} className="w-8 h-8 rounded-full object-cover" />
                                                    ) : (
                                                        <div className="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-xs font-bold text-slate-600 dark:text-slate-300">
                                                                {c.name.charAt(0)}
                                                        </div>
                                                    )}
                                                    <div>
                                                        <div>{c.name}</div>
                                                        {c.email && <div className="text-[10px] text-gray-400 font-normal">{c.email}</div>}
                                                    </div>
                                                </td>
                                                <td className="p-4 dark:text-slate-300 dir-ltr text-right">{c.phone}</td>
                                                <td className="p-4 dark:text-slate-300 font-bold">{c.totalOrders}</td>
                                                <td className="p-4 font-bold text-green-600 dark:text-green-400">{c.totalSpent.toFixed(1)} Ø±.Ø³</td>
                                                <td className="p-4 text-xs text-gray-400">
                                                    {c.lastOrderDate?.seconds ? new Date(c.lastOrderDate.seconds * 1000).toLocaleDateString('ar-EG') : '-'}
                                                </td>
                                                <td className="p-4">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${status.class}`}>{status.label}</span>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {filteredCustomers.length === 0 && <div className="p-8 text-center text-gray-500 dark:text-slate-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†</div>}
                        </div>
                    </div>
                )}

                {activeTab === 'ratings' && (
                    <div className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm transition-colors">
                        <table className="w-full text-right text-sm">
                            <thead className="bg-slate-5 dark:bg-slate-700 text-gray-500 dark:text-slate-300">
                                <tr>
                                    <th className="p-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th className="p-4">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                                    <th className="p-4">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</th>
                                    <th className="p-4">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th className="p-4">Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                                {ratings.map(r => {
                                    const status = getCustomerStatus(r, 'rating');
                                    const safeRating = Math.min(5, Math.max(0, Math.floor(Number(r.rating) || 0)));
                                    
                                    let displayName = r.customerName || r.userName || r.guestName;
                                    let displayPhoto = r.customerPhoto || r.userPhoto;
                                    
                                    if (!displayName) {
                                        const linkedCust = customersData.find(c => (r.customerId && c.userId === r.customerId) || (r.phone && c.phone === r.phone));
                                        if (linkedCust) { 
                                            displayName = linkedCust.name; 
                                            if (!displayPhoto) displayPhoto = linkedCust.photo; 
                                        } else if (r.phone) {
                                            displayName = "Ø²Ø§Ø¦Ø±"; 
                                        }
                                    }
                                    
                                    const safeName = displayName || 'Ø¹Ù…ÙŠÙ„ Ù…Ø¬Ù‡ÙˆÙ„';

                                    return (
                                        <tr key={r.id} className="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors cursor-pointer" onClick={() => setSelectedRating({...r, customerName: safeName, customerPhoto: displayPhoto})}>
                                            <td className="p-4 font-bold dark:text-white">
                                                <div className="flex items-center gap-3">
                                                    {displayPhoto ? (<img src={displayPhoto} className="w-10 h-10 rounded-full object-cover border border-gray-200 dark:border-gray-600" alt="Avatar"/>) : (<div className="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-sm font-bold text-slate-600 dark:text-slate-300 flex-shrink-0">{safeName.charAt(0)}</div>)}
                                                    <div>
                                                        <div className="text-base">{safeName}</div>
                                                        {r.phone && <div className="text-xs text-gray-400 dir-ltr text-right">{r.phone}</div>}
                                                        <div className={`text-[10px] px-2 py-0.5 rounded-full w-fit mt-1 ${status.class}`}>{status.label}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="p-4 text-yellow-500 font-bold text-lg">{"â˜…".repeat(safeRating)}{"â˜†".repeat(5-safeRating)}</td>
                                            <td className="p-4 dark:text-slate-300 max-w-xs">{r.comment || '-'}</td>
                                            <td className="p-4 text-xs text-gray-400">{r.createdAt?.seconds ? new Date(r.createdAt.seconds * 1000).toLocaleDateString('ar-EG') : '-'}</td>
                                            <td className="p-4"><button onClick={(e) => { e.stopPropagation(); handleDeleteRating(r.id); }} className="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 py-1 rounded text-xs hover:bg-red-200 dark:hover:bg-red-900/50">Ø­Ø°Ù</button></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                        {ratings.length === 0 && <div className="p-8 text-center text-gray-500 dark:text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>}
                    </div>
                )}

                {activeTab === 'menu' && (
                    <div>
                        <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                {categories.map(c => (
                                    <button key={c} onClick={() => setFilterCategory(c)} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors border whitespace-nowrap ${filterCategory === c ? 'bg-slate-900 dark:bg-slate-600 text-white border-slate-900 dark:border-slate-600' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>{c}</button>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleApplyGlobalDiscount} className="bg-purple-600 text-white px-4 py-2 rounded-lg flex gap-2 font-bold hover:bg-purple-700 whitespace-nowrap"><Percent size={18}/> Ø®ØµÙ… Ø¬Ù…Ø§Ø¹ÙŠ</button>
                                {/* Ø²Ø± Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø© Ù…Ù†ÙØµÙ„ */}
                                <button onClick={() => openForm(null, 'meal')} className="bg-green-600 text-white px-4 py-2 rounded-lg flex gap-2 font-bold hover:bg-green-700 whitespace-nowrap"><ChefHat size={18}/> Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø©</button>
                                <button onClick={() => openForm(null, 'item')} className="bg-orange-600 text-white px-4 py-2 rounded-lg flex gap-2 font-bold hover:bg-orange-700 whitespace-nowrap"><Plus size={18}/> Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {filteredItems.map(item => (
                                <div key={item.id} className={`bg-white dark:bg-slate-800 p-4 rounded-xl border ${item.type === 'meal' ? 'border-green-200 dark:border-green-900' : 'border-slate-200 dark:border-slate-700'} shadow-sm flex justify-between items-start group relative transition-colors`}>
                                    <div className="flex gap-4 w-full">
                                        <div className="w-16 h-16 bg-gray-100 dark:bg-slate-700 rounded-lg overflow-hidden flex-shrink-0 relative">
                                            {item.image ? <img src={item.image} className="w-full h-full object-cover"/> : <span className="flex items-center justify-center h-full text-2xl">ğŸ¥˜</span>}
                                            
                                            {item.discount > 0 && <span className="absolute top-0 right-0 bg-red-600 text-white text-[10px] px-1 font-bold">-{item.discount}%</span>}
                                            
                                            {(item.prepTimeValue) && (
                                                <span className="absolute top-0 left-0 bg-red-600 text-white text-[8px] px-1 font-bold rounded-br z-10">
                                                    {item.prepTimeType === 'Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨' ? 'Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨' : 'ØªØ­Ø¶ÙŠØ±'} {item.prepTimeValue}Ø¯
                                                </span>
                                            )}
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="font-bold dark:text-white flex items-center gap-2">
                                                {item.name}
                                                {item.type === 'meal' && <span className="bg-green-100 text-green-700 text-[10px] px-2 rounded-full">ÙˆØ¬Ø¨Ø©</span>}
                                            </h4>
                                            
                                            {/* Ø¹Ø±Ø¶ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ¬Ø¨Ø© */}
                                            {item.type === 'meal' && (
                                                <div className="text-xs text-gray-500 mt-1 line-clamp-2">{item.components}</div>
                                            )}
                                            
                                            <div className="flex flex-wrap gap-1 mt-1">
                                                <span className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-600 dark:text-slate-300">{item.category}</span>
                                                <span className="text-xs bg-blue-50 dark:bg-slate-700 px-2 py-0.5 rounded text-blue-600 dark:text-blue-400">#{item.order || 999}</span>
                                                {item.type === 'meal' && (
                                                    <span className={`text-xs px-2 py-0.5 rounded ${item.hasRice ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-500'}`}>
                                                        {item.hasRice ? 'Ù…Ø¹ Ø±Ø²' : 'Ø¨Ø¯ÙˆÙ† Ø±Ø²'}
                                                    </span>
                                                )}
                                                {item.hasVariants && <span className="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded">Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</span>}
                                            </div>
                                            <div className="mt-2 font-bold text-orange-600 dark:text-orange-400">{item.price} Ø±.Ø³</div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2"><button onClick={() => openForm(item)} className="p-2 bg-gray-100 dark:bg-slate-700 rounded hover:bg-gray-200 dark:hover:bg-slate-600 dark:text-slate-200"><Edit size={16}/></button><button onClick={() => handleDeleteItem(item.id)} className="p-2 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded hover:bg-red-100 dark:hover:bg-red-900/50"><Trash2 size={16}/></button></div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                    
                {activeTab === 'orders' && (
                    <div className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden overflow-x-auto transition-colors">
                        <table className="w-full text-right text-sm min-w-[800px]">
                            <thead className="bg-slate-5 dark:bg-slate-700 text-gray-500 dark:text-slate-300">
                                <tr><th className="p-4">Ø±Ù‚Ù… / Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th className="p-4">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th className="p-4">Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th><th className="p-4">ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ (KSA)</th><th className="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th><th className="p-4">Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                                {orders.map(o => {
                                    const status = getCustomerStatus(o, 'order');
                                    return (
                                    <tr key={o.id} className="hover:bg-slate-5 dark:hover:bg-slate-700 transition-colors cursor-pointer" onClick={() => setSelectedOrder(o)}>
                                            <td className="p-4"><div className="font-bold text-slate-800 dark:text-white">{o.customerName}</div><div className="text-xs text-gray-500 dark:text-slate-400">{o.phone}</div><div className={`text-[10px] px-2 py-0.5 rounded-full w-fit mt-1 ${status.class}`}>{status.label}</div></td>
                                            <td className="p-4"><div className="max-w-xs text-xs dark:text-slate-300">{o.itemsString}</div><div className="font-bold text-orange-600 dark:text-orange-400 mt-1">{o.total} Ø±.Ø³</div></td>
                                            <td className="p-4"><div className="text-xs font-bold dark:text-slate-200">{o.deliveryType}</div><div className="text-xs text-green-600 dark:text-green-400">{o.paymentType}</div></td>
                                            <td className="p-4 text-xs font-bold text-slate-700 dark:text-slate-300 dir-ltr text-right">{o.orderDateKSA ? o.orderDateKSA : '-'}</td>
                                            <td className="p-4"><span className="px-2 py-1 rounded text-xs font-bold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300">{o.status}</span></td>
                                            <td className="p-4 flex flex-col sm:flex-row gap-2"><button onClick={(e) => { e.stopPropagation(); toggleOrderStatus(o); }} className="bg-slate-800 dark:bg-slate-600 text-white px-3 py-1 rounded text-xs hover:bg-slate-700 dark:hover:bg-slate-500">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</button></td>
                                    </tr>
                                )})}
                            </tbody>
                        </table>
                    </div>
                )}

                {activeTab === 'discounts' && (
                    <div className="max-w-4xl mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                            <h3 className="font-bold text-xl flex gap-2 items-center mb-4 md:mb-0 dark:text-white"><Tag className="text-orange-600 dark:text-orange-400"/> Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…</h3>
                            <button onClick={() => setShowForm(true)} className="bg-orange-600 text-white px-4 py-2 rounded-lg flex gap-2 font-bold hover:bg-orange-700 w-full md:w-auto"><Plus size={18}/> Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        <div className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm overflow-x-auto transition-colors">
                            <table className="w-full text-right text-sm min-w-[400px]">
                                <thead className="bg-slate-5 dark:bg-slate-700 text-gray-500 dark:text-slate-300">
                                    <tr><th className="p-4">Ø§Ù„ÙƒÙˆØ¯</th><th className="p-4">Ø§Ù„Ø®ØµÙ…</th><th className="p-4">Ø­Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th><th className="p-4">Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                                    {discounts.map(d => (
                                        <tr key={d.id}><td className="p-4 font-bold font-mono text-lg dark:text-white">{d.code}</td><td className="p-4 text-green-600 dark:text-green-400 font-bold">{(d.value * 100)}%</td><td className="p-4 dark:text-slate-300">{d.perUserLimit}</td><td className="p-4"><button onClick={() => handleDeleteDiscount(d.id)} className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-2 rounded"><Trash2 size={16}/></button></td></tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
                
                {activeTab === 'site-settings' && (
                    <div className="max-w-3xl mx-auto bg-white dark:bg-slate-800 p-4 md:p-8 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm transition-colors">
                        <h3 className="font-bold text-xl mb-6 dark:text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
                        <form onSubmit={handleSaveSettings} className="space-y-6">
                            <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800">
                                <div className="flex justify-between items-center mb-2"><label className="font-bold dark:text-slate-200">Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠ</label><input type="checkbox" checked={siteSettings.showAnnouncement} onChange={e => setSiteSettings({...siteSettings, showAnnouncement: e.target.checked})} className="w-5 h-5"/></div>
                                <input type="text" value={siteSettings.announcement} onChange={e => setSiteSettings({...siteSettings, announcement: e.target.value})} className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white mb-2"/>
                                <div className="flex gap-2"><input type="color" value={siteSettings.announcementBgColor} onChange={e => setSiteSettings({...siteSettings, announcementBgColor: e.target.value})}/><input type="color" value={siteSettings.announcementTextColor} onChange={e => setSiteSettings({...siteSettings, announcementTextColor: e.target.value})}/></div>
                            </div>
                            <div className="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-100 dark:border-purple-800">
                                <div className="flex justify-between items-center mb-2"><label className="font-bold dark:text-slate-200">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚</label><input type="checkbox" checked={siteSettings.showPopup} onChange={e => setSiteSettings({...siteSettings, showPopup: e.target.checked})} className="w-5 h-5"/></div>
                                <input type="text" value={siteSettings.popupImage} onChange={e => setSiteSettings({...siteSettings, popupImage: e.target.value})} placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white dir-ltr"/>
                            </div>
                            <div className="p-4 bg-gray-50 dark:bg-slate-700 rounded-lg border border-gray-200 dark:border-slate-600">
                                <label className="block font-bold mb-2 dark:text-slate-200">ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙŠØ±Ùˆ</label><input type="text" value={siteSettings.heroImage} onChange={e => setSiteSettings({...siteSettings, heroImage: e.target.value})} className="w-full p-2 border border-slate-300 dark:border-slate-500 rounded bg-white dark:bg-slate-600 dark:text-white mb-2 dir-ltr"/>
                                <label className="block font-bold mb-2 dark:text-slate-200">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label><input type="text" value={siteSettings.heroTitle} onChange={e => setSiteSettings({...siteSettings, heroTitle: e.target.value})} className="w-full p-2 border border-slate-300 dark:border-slate-500 rounded bg-white dark:bg-slate-600 dark:text-white"/>
                            </div>
                            <button className="w-full bg-slate-900 dark:bg-slate-600 text-white py-3 rounded-lg font-bold">Ø­ÙØ¸</button>
                        </form>
                    </div>
                )}

            </div>
        </main>

        {/* Live Notification Toast */}
        {liveNotification && (
            <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-900 dark:bg-slate-700 text-white px-6 py-4 rounded-xl shadow-2xl z-[100] flex items-center gap-4 toast-animate cursor-pointer border border-slate-700 dark:border-slate-600 max-w-sm w-full" onClick={() => { setActiveTab('orders'); setLiveNotification(null); }}>
                <div className="bg-green-600 rounded-full p-3 text-white flex-shrink-0 animate-pulse"><Bell size={24} /></div>
                <div className="flex-1"><h4 className="font-bold text-lg mb-1">{liveNotification.title}</h4><p className="text-slate-300 text-sm">{liveNotification.message}</p><p className="text-slate-500 dark:text-slate-400 text-xs mt-1">{liveNotification.time}</p></div>
                <button onClick={(e) => { e.stopPropagation(); setLiveNotification(null); }} className="text-slate-400 hover:text-white"><X size={20}/></button>
            </div>
        )}

        {/* Customer Detail Modal - UPDATED (Enhanced & Responsive) */}
        {selectedCustomer && (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto modal-animate transition-colors">
                    {/* Header */}
                    <div className="p-6 border-b dark:border-slate-700 flex justify-between items-center sticky top-0 bg-white dark:bg-slate-800 z-10">
                        <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <User size={24} className="text-blue-500"/>
                            Ù…Ù„Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ 
                            {selectedCustomer.totalOrders > 1 && <BadgeCheck className="text-orange-500" size={20}/>}
                        </h3>
                        <div className="flex gap-2">
                            <button onClick={handlePrintCustomerFile} className="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center gap-2"><Printer size={16}/> <span className="hidden sm:inline">Ø·Ø¨Ø§Ø¹Ø©</span></button>
                            <button onClick={() => handleDeleteCustomer(selectedCustomer)} className="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-200 dark:hover:bg-red-900/50 flex items-center gap-2"><Trash2 size={16}/> <span className="hidden sm:inline">Ø­Ø°Ù</span></button>
                            <button onClick={() => setSelectedCustomer(null)} className="p-2 bg-slate-100 dark:bg-slate-700 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"><X size={20} /></button>
                        </div>
                    </div>
                    
                    <div className="p-6 space-y-8">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                             {/* Info */}
                            <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800 flex items-center gap-4">
                                <div className="w-12 h-12 bg-blue-100 dark:bg-blue-800 text-blue-600 dark:text-blue-200 rounded-full flex items-center justify-center text-xl font-bold">
                                     {selectedCustomer.name.charAt(0)}
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500 dark:text-slate-400">Ø§Ù„Ø§Ø³Ù…</p>
                                    <p className="font-bold dark:text-white text-lg">{selectedCustomer.name}</p>
                                </div>
                            </div>
                            {/* Phone */}
                            <div className="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-100 dark:border-green-800 flex items-center gap-4">
                                 <div className="w-12 h-12 bg-green-100 dark:bg-green-800 text-green-600 dark:text-green-200 rounded-full flex items-center justify-center">
                                     <Phone size={20}/>
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500 dark:text-slate-400">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</p>
                                    <p className="font-bold dark:text-white dir-ltr text-right font-mono">{selectedCustomer.phone}</p>
                                </div>
                            </div>
                            {/* Stats */}
                            <div className="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-100 dark:border-purple-800 flex flex-col justify-center">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-xs text-slate-500 dark:text-slate-400">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                                    <span className="font-bold dark:text-white">{selectedCustomer.totalOrders}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-xs text-slate-500 dark:text-slate-400">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                                    <span className="font-bold text-green-600 dark:text-green-400">{selectedCustomer.totalSpent.toFixed(1)} Ø±.Ø³</span>
                                </div>
                            </div>
                        </div>

                        {/* Orders List */}
                        <div>
                            <h4 className="font-bold text-lg mb-4 dark:text-white flex items-center gap-2"><Clock size={20} className="text-orange-500"/> Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
                            <div className="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden shadow-sm overflow-x-auto">
                                <table className="w-full text-right text-sm min-w-[600px]">
                                    <thead className="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 border-b dark:border-slate-700">
                                        <tr>
                                            <th className="p-4">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                                            <th className="p-4">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th className="p-4">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</th>
                                            <th className="p-4">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                            <th className="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th className="p-4"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                        {selectedCustomer.orders.sort((a,b) => b.createdAt.seconds - a.createdAt.seconds).map(order => (
                                            <tr key={order.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer group transition-colors" onClick={() => setSelectedOrder(order)}>
                                                <td className="p-4 font-mono font-bold text-slate-700 dark:text-slate-300">#{String(order.createdAt?.seconds || '').slice(-4)}</td>
                                                <td className="p-4 text-slate-500 dark:text-slate-400">{order.orderDateKSA ? order.orderDateKSA.split(',')[0] : '-'}</td>
                                                <td className="p-4 max-w-xs">
                                                    <p className="truncate text-slate-700 dark:text-slate-300" title={order.itemsString}>{order.itemsString.split('\n')[0]}</p>
                                                    <p className="text-xs text-slate-400">{order.itemsString.split('\n').length > 1 ? `+ ${order.itemsString.split('\n').length - 1} Ø£ØµÙ†Ø§Ù Ø£Ø®Ø±Ù‰` : ''}</p>
                                                </td>
                                                <td className="p-4 font-bold text-green-600 dark:text-green-400">{order.total} Ø±.Ø³</td>
                                                <td className="p-4">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${order.status === 'Ø¬Ø¯ÙŠØ¯' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300'}`}>
                                                        {order.status}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-center">
                                                     <div className="p-2 bg-slate-100 dark:bg-slate-700 rounded-full text-slate-400 group-hover:text-orange-500 group-hover:bg-orange-50 dark:group-hover:bg-orange-900/20 transition-colors w-fit mx-auto">
                                                         <Eye size={16}/>
                                                     </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* ORDER DETAILS MODAL - ğŸ”¥ğŸ”¥ğŸ”¥ RE-DESIGNED ğŸ”¥ğŸ”¥ğŸ”¥ */}
        {selectedOrder && (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto modal-animate transition-colors flex flex-col">
                    
                    {/* Header */}
                    <div className="p-5 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900 sticky top-0 z-10">
                        <div>
                            <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <Receipt size={24} className="text-orange-500"/>
                                ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ <span className="font-mono text-slate-500">#{String(selectedOrder.createdAt?.seconds || '').slice(-4)}</span>
                            </h3>
                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{selectedOrder.orderDateKSA}</p>
                        </div>
                        <button onClick={() => setSelectedOrder(null)} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors"><X size={24} className="text-slate-500 dark:text-slate-400" /></button>
                    </div>

                    <div className="p-6 space-y-6 flex-1">
                        
                        {/* Customer & Status Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Customer Info Card */}
                            <div className="bg-white dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                                <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-3 flex items-center gap-2"><User size={18} className="text-blue-500"/> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
                                <div className="space-y-2">
                                    <p className="text-lg font-bold dark:text-white">{selectedOrder.customerName}</p>
                                    <a href={`tel:${selectedOrder.phone}`} className="inline-flex items-center gap-2 text-slate-600 dark:text-slate-300 hover:text-blue-600 dir-ltr font-mono bg-slate-100 dark:bg-slate-600 px-2 py-1 rounded text-sm"><Phone size={14}/> {selectedOrder.phone}</a>
                                </div>
                            </div>

                            {/* Order Status & Delivery Card */}
                            <div className="bg-white dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                                <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-3 flex items-center gap-2"><MapPin size={18} className="text-green-500"/> Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØ§Ù„Ø­Ø§Ù„Ø©</h4>
                                <div className="flex justify-between items-start">
                                    <div className="space-y-1">
                                        <p className="font-bold dark:text-white">{selectedOrder.deliveryType}</p>
                                        {selectedOrder.deliveryDetails && <p className="text-xs text-slate-500 dark:text-slate-400 whitespace-pre-wrap">{selectedOrder.deliveryDetails.replace('ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:', '').replace('ğŸš— Ø³ÙŠØ§Ø±Ø©:', '')}</p>}
                                    </div>
                                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${selectedOrder.status === 'Ø¬Ø¯ÙŠØ¯' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'}`}>{selectedOrder.status}</span>
                                </div>
                            </div>
                        </div>

                        {/* Items Table - ğŸ”¥ NEW STRUCTURED VIEW ğŸ”¥ */}
                        <div>
                            <h4 className="font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2"><ShoppingBag size={18} className="text-orange-500"/> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h4>
                            <div className="border border-slate-200 dark:border-slate-600 rounded-xl overflow-hidden shadow-sm overflow-x-auto">
                                <table className="w-full text-sm text-right min-w-full">
                                    <thead className="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400">
                                        <tr>
                                            <th className="p-3 font-bold whitespace-nowrap">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                            <th className="p-3 font-bold min-w-[120px]">Ø§Ù„ØµÙ†Ù</th>
                                            <th className="p-3 font-bold min-w-[150px]">Ø§Ù„ØªÙØ§ØµÙŠÙ„ / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                            <th className="p-3 font-bold whitespace-nowrap">Ø§Ù„Ø³Ø¹Ø±</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                        {/* Check if we have structured items array */}
                                        {selectedOrder.items && Array.isArray(selectedOrder.items) ? (
                                            selectedOrder.items.map((item, idx) => (
                                                <tr key={idx} className="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                                                    <td className="p-3 font-bold text-slate-700 dark:text-slate-200 whitespace-nowrap">x{item.qty}</td>
                                                    <td className="p-3 font-bold text-slate-800 dark:text-white">{item.title}</td>
                                                    <td className="p-3 text-slate-600 dark:text-slate-400">
                                                        <div className="flex flex-col gap-1">
                                                            {item.size && <span className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded w-fit">{item.size}</span>}
                                                            {item.rice && <span className="text-xs text-orange-600 dark:text-orange-400 font-bold">{item.rice}</span>}
                                                            
                                                            {/* With/Without Additions Badge */}
                                                            {item.isWithoutAdditions ? (
                                                                <span className="text-xs bg-red-100 text-red-700 border border-red-200 px-2 py-0.5 rounded w-fit font-bold">Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ§Øª</span>
                                                            ) : (
                                                                /* Show 'With Additions' only if it looks like a meal (has rice or size) to avoid showing it for drinks */
                                                                (item.rice || item.size || item.title.includes('ÙˆØ¬Ø¨Ø©')) && (
                                                                     <span className="text-xs bg-emerald-100 text-emerald-700 border border-emerald-200 px-2 py-0.5 rounded w-fit font-bold">Ø´Ø§Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</span>
                                                                )
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="p-3 whitespace-nowrap">
                                                        <div className="font-bold text-slate-700 dark:text-slate-200">{(item.price * item.qty).toFixed(1)} Ø±.Ø³</div>
                                                        {item.qty > 0 && <div className="text-xs text-slate-400 dark:text-slate-500 font-mono mt-1" dir="ltr">{item.price} / item</div>}
                                                    </td>
                                                </tr>
                                            ))
                                        ) : (
                                            /* Fallback for old string-based orders */
                                            selectedOrder.itemsString.split('\n').filter(line => line.trim() && !line.includes('-----')).map((line, idx) => (
                                                <tr key={idx}>
                                                    <td className="p-3" colSpan="4">{line}</td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                    <tfoot className="bg-slate-50 dark:bg-slate-900 border-t dark:border-slate-700">
                                        <tr>
                                            <td colSpan="3" className="p-3 font-bold text-slate-700 dark:text-slate-300">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</td>
                                            <td className="p-3 font-bold text-lg text-green-600 dark:text-green-400 whitespace-nowrap">{selectedOrder.total} Ø±.Ø³</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                    </div>

                    {/* Footer Actions */}
                    <div className="p-5 border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex justify-between items-center gap-3">
                        <div className="text-xs text-slate-500 font-mono">
                           Payment: {selectedOrder.paymentType}
                        </div>
                        <div className="flex gap-2">
                             <button onClick={() => setSelectedOrder(null)} className="px-5 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg font-bold hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-slate-200 transition-colors">Ø¥ØºÙ„Ø§Ù‚</button>
                             <button onClick={handlePrintOrder} className="px-5 py-2 bg-slate-800 dark:bg-slate-600 text-white rounded-lg font-bold hover:bg-slate-900 dark:hover:bg-slate-500 transition-colors flex gap-2 items-center shadow-lg shadow-slate-500/20"><Printer size={18}/> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* SECURITY MODAL */}
        {showSecurityModal && (
            <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
                <div className="bg-white dark:bg-slate-800 rounded-xl p-6 md:p-8 w-full max-w-sm text-center shadow-2xl relative transition-colors">
                    <button onClick={() => { setShowSecurityModal(false); setPendingTab(null); setPendingDeleteId(null); }} className="absolute top-4 left-4 text-gray-400 hover:text-red-500"><X/></button>
                    <div className="w-16 h-16 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full flex items-center justify-center mx-auto mb-4"><ShieldCheck size={32}/></div>
                    <h3 className="text-xl font-bold mb-2 dark:text-white">{pendingDeleteId ? "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù" : "Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ù…ÙŠØ©"}</h3>
                    <p className="text-gray-500 dark:text-slate-400 mb-6">{pendingDeleteId ? "Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹." : "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù„Ù„ÙˆØµÙˆÙ„"}</p>
                    <form onSubmit={handleSecurityCheck}><input type="password" name="pin" maxLength="4" className="w-full text-center text-3xl font-bold p-3 border-2 border-slate-200 dark:border-slate-600 rounded-lg mb-4 bg-white dark:bg-slate-700 dark:text-white" placeholder="â€¢â€¢â€¢â€¢" autoFocus/><button className="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold">{pendingDeleteId ? "Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ" : "Ø¯Ø®ÙˆÙ„"}</button></form>
                </div>
            </div>
        )}

        {/* FORM MODAL */}
        {showForm && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative transition-colors">
                    <button onClick={() => setShowForm(false)} className="absolute top-4 left-4 dark:text-slate-400 dark:hover:text-white"><X/></button>
                    {activeTab === 'discounts' ? (
                        <form onSubmit={handleSaveDiscount} className="space-y-4">
                            <input name="code" placeholder="Ø§Ù„ÙƒÙˆØ¯" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white" required />
                            <input name="value" type="number" placeholder="Ø§Ù„Ù†Ø³Ø¨Ø© %" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white" required />
                            <input name="perUserLimit" type="number" placeholder="Ø­Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white" required />
                            <button className="w-full bg-orange-600 text-white py-3 rounded">Ø­ÙØ¸</button>
                        </form>
                    ) : (
                        <form onSubmit={handleSaveItem} className="space-y-4">
                            
                            <h3 className="font-bold text-lg dark:text-white mb-2 border-b dark:border-slate-700 pb-2">
                                {formType === 'meal' ? 'Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø© Ù…Ø¬Ù…Ø¹Ø©' : 'Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù…ÙØ±Ø¯'}
                            </h3>

                            <div className="flex flex-col md:flex-row gap-4">
                                <div className="flex-[3]"><label className="dark:text-slate-200">Ø§Ù„Ø§Ø³Ù…</label><input name="name" defaultValue={currentItem?.name} className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white" required /></div>
                                <div className="flex-1"><label className="dark:text-slate-200">Ø§Ù„ØªØ±ØªÙŠØ¨</label><input name="order" type="number" defaultValue={currentItem?.order} className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"/></div>
                            </div>
                            
                            <div className="bg-red-50 dark:bg-red-900/20 p-2 rounded flex flex-col sm:flex-row items-center gap-2 border border-red-100 dark:border-red-900/30"><Tag size={16} className="text-red-600 dark:text-red-400"/><label className="text-sm font-bold text-red-700 dark:text-red-300">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%):</label><input name="discount" type="number" min="0" max="100" defaultValue={currentItem?.discount || 0} className="w-full sm:w-20 p-1 border rounded text-center bg-white dark:bg-slate-700 dark:text-white dark:border-slate-600"/></div>
                            
                            {formType === 'meal' ? (
                                <>
                                    <div className="bg-green-50 dark:bg-green-900/20 p-3 rounded space-y-3 border border-green-100 dark:border-green-900/30">
                                        <div>
                                            <label className="block text-sm font-bold mb-1 dark:text-slate-200">Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ¬Ø¨Ø©</label>
                                            <textarea 
                                                value={mealComponents} 
                                                onChange={(e) => setMealComponents(e.target.value)} 
                                                placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ¬Ø¨Ø© (Ù…Ø«Ù„Ø§Ù‹: Ù†ØµÙ Ø¯Ø¬Ø§Ø¬Ø©ØŒ Ø¥ÙŠØ¯Ø§Ù…ØŒ Ø³Ù„Ø·Ø©ØŒ Ø¨ÙŠØ¨Ø³ÙŠ)"
                                                className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white h-24"
                                            ></textarea>
                                        </div>
                                        
                                        {/* ğŸ”¥ğŸ”¥ Ø®ÙŠØ§Ø± Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ§Øª ğŸ”¥ğŸ”¥ */}
                                        <div className="flex items-center gap-2 p-2 bg-white dark:bg-slate-700 rounded border border-slate-200 dark:border-slate-600">
                                            <input 
                                                type="checkbox" 
                                                checked={isWithoutAdditions} 
                                                onChange={(e) => setIsWithoutAdditions(e.target.checked)} 
                                                className="w-5 h-5 text-green-600 rounded focus:ring-green-500"
                                            />
                                            <label className="font-bold text-sm text-slate-700 dark:text-slate-200">
                                                Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ§Øª (Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø§Ø¯Ø¬ "Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ§Øª")
                                                <span className="block text-xs text-gray-400 font-normal">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ø³ÙŠØ¸Ù‡Ø± Ø¨Ø§Ø¯Ø¬ Ø±Ù…Ø§Ø¯ÙŠ Ø¹Ù„Ù‰ ÙƒØ§Ø±Øª Ø§Ù„ÙˆØ¬Ø¨Ø©</span>
                                            </label>
                                        </div>

                                        <div className="bg-white dark:bg-slate-700 p-3 rounded border border-slate-200 dark:border-slate-600">
                                            <label className="block text-sm font-bold mb-2 dark:text-slate-200">Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø² (ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø¨Ù‚)</label>
                                            <div className="flex gap-4">
                                                <label className={`flex-1 p-3 rounded-lg border-2 cursor-pointer text-center transition-all ${mealHasRice ? 'border-green-500 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600'}`}>
                                                    <input type="radio" name="riceOpt" checked={mealHasRice} onChange={() => setMealHasRice(true)} className="hidden" />
                                                    <div className="font-bold">Ù…Ø¹ Ø§Ù„Ø±Ø² ğŸš</div>
                                                    <div className="text-[10px]">Ø§Ù„ÙˆØ¬Ø¨Ø© ØªØ´Ù…Ù„ Ø±Ø²</div>
                                                </label>
                                                <label className={`flex-1 p-3 rounded-lg border-2 cursor-pointer text-center transition-all ${!mealHasRice ? 'border-red-500 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300' : 'border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600'}`}>
                                                    <input type="radio" name="riceOpt" checked={!mealHasRice} onChange={() => setMealHasRice(false)} className="hidden" />
                                                    <div className="font-bold">Ø¨Ø¯ÙˆÙ† Ø±Ø² ğŸ¥–</div>
                                                    <div className="text-[10px]">Ø§Ù„ÙˆØ¬Ø¨Ø© Ø¨Ø¯ÙˆÙ† Ø±Ø²</div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    {/* --- Ù‚Ø³Ù… Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (Variants) --- */}
                                    <div className="bg-purple-50 dark:bg-purple-900/20 p-3 rounded border border-purple-100 dark:border-purple-900/30">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="font-bold text-sm text-purple-800 dark:text-purple-300 flex items-center gap-2"><Layers size={16}/> Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙˆØ¬Ø¨Ø© (Ø£Ù†ÙˆØ§Ø¹)</label>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs dark:text-slate-300">ØªÙØ¹ÙŠÙ„</span>
                                                <input type="checkbox" checked={hasVariants} onChange={e => setHasVariants(e.target.checked)} className="w-4 h-4"/>
                                            </div>
                                        </div>
                                        {hasVariants && (
                                            <div className="space-y-3">
                                                {variants.map((v, i) => (
                                                    <div key={i} className="flex flex-col gap-2 p-2 border border-slate-200 dark:border-slate-600 rounded bg-slate-50 dark:bg-slate-800">
                                                        <div className="flex gap-2 items-center">
                                                            <input value={v.name} onChange={e => updateVariantName(i, e.target.value)} placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ù„Ø§Ù‹: Ù…Ø¸Ø¨ÙŠ)" className="flex-1 p-2 border border-slate-300 dark:border-slate-600 rounded text-sm bg-white dark:bg-slate-700 dark:text-white"/>
                                                            <input value={v.image} onChange={e => updateVariantImage(i, e.target.value)} placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" className="flex-1 p-2 border border-slate-300 dark:border-slate-600 rounded text-sm dir-ltr bg-white dark:bg-slate-700 dark:text-white"/>
                                                            <button type="button" onClick={() => removeVariant(i)} className="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"><Trash2 size={16}/></button>
                                                        </div>
                                                        <textarea value={v.details} onChange={e => updateVariantDetails(i, e.target.value)} placeholder="ØªÙØ§ØµÙŠÙ„/Ù…ÙƒÙˆÙ†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded text-sm bg-white dark:bg-slate-700 dark:text-white h-16"></textarea>
                                                        <input value={v.price} type="number" step="any" onChange={e => { const newV = [...variants]; newV[i].price = e.target.value; setVariants(newV); }} placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø®Ø§Øµ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded text-sm bg-white dark:bg-slate-700 dark:text-white"/>
                                                    </div>
                                                ))}
                                                <button type="button" onClick={addVariant} className="text-purple-600 dark:text-purple-400 text-sm font-bold flex items-center gap-1 hover:underline">+ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±</button>
                                            </div>
                                        )}
                                    </div>

                                    <input name="price" type="number" step="any" defaultValue={currentItem?.price} placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ¬Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"/>
                                </>
                            ) : (
                                <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded">
                                    <div className="flex justify-between dark:text-slate-200"><label>Ø£Ø­Ø¬Ø§Ù…ØŸ</label><input type="checkbox" checked={hasSizes} onChange={e=>setHasSizes(e.target.checked)}/></div>
                                    {hasSizes && <div className="mt-2 dark:text-slate-200"><label>Ø³Ø§Ø¯Ø©/Ø±Ø²ØŸ</label><input type="checkbox" checked={hasPlainOption} onChange={e=>setHasPlainOption(e.target.checked)}/></div>}
                                    {hasSizes ? (
                                        <div className="mt-2 space-y-2">
                                            <div className="flex flex-col sm:flex-row gap-2 text-xs font-bold px-1 dark:text-slate-200"><span>Ø§Ù„Ø­Ø¬Ù…</span>{hasPlainOption ? <><span>Ø³Ø§Ø¯Ø©</span><span>Ø±Ø²</span></> : <span>Ø§Ù„Ø³Ø¹Ø±</span>}<span></span></div>
                                            {sizes.map((s,i)=>(<div key={i} className="flex flex-col sm:flex-row gap-1"><input value={s.name} onChange={e=>updateSizeName(i,e.target.value)} className="w-full p-1 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"/>{hasPlainOption ? <><input type="number" step="any" value={s.plainPrice} onChange={e=>updateSizePlainPrice(i,e.target.value)} className="w-full p-1 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"/><input type="number" step="any" value={s.ricePrice} onChange={e=>updateSizeRicePrice(i,e.target.value)} className="w-full p-1 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"/></> : <input type="number" step="any" value={s.price} onChange={e=>updateSizePrice(i,e.target.value)} className="w-full p-1 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"/>}<button type="button" onClick={()=>removeSize(i)} className="text-red-500 hover:text-red-700">X</button></div>))}
                                            <button type="button" onClick={addSize} className="text-blue-600 dark:text-blue-400 text-sm">+ Ø­Ø¬Ù…</button>
                                        </div>
                                    ) : (
                                        <input name="price" type="number" step="any" defaultValue={currentItem?.price} placeholder="Ø§Ù„Ø³Ø¹Ø±" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded mt-2 bg-white dark:bg-slate-700 dark:text-white"/>
                                    )}
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-2"><select name="category" defaultValue={currentItem?.category} className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white">{FIXED_CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}</select><input name="calories" defaultValue={currentItem?.calories} placeholder="Ø§Ù„Ø³Ø¹Ø±Ø§Øª" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"/></div>
                            
                            {formType !== 'meal' && (
                                <>
                                <div className="bg-red-50 dark:bg-red-900/20 p-3 rounded mt-2 border border-red-100 dark:border-red-900/30">
                                    <label className="block text-sm font-bold text-red-800 dark:text-red-300 mb-2">ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ±</label>
                                    <div className="flex gap-2">
                                        <select name="prepTimeType" defaultValue={currentItem?.prepTimeType || "ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ±"} className="w-1/2 p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white">
                                            <option value="ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ±">ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ±</option>
                                            <option value="Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨">Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨</option>
                                        </select>
                                        <input name="prepTimeValue" type="number" defaultValue={currentItem?.prepTimeValue} placeholder="Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Ù…Ø«Ù„Ø§Ù‹ 15)" className="w-1/2 p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white" />
                                    </div>
                                </div>
                                <div className="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded mt-2">
                                    <div className="flex justify-between dark:text-slate-200"><label>Ø®ÙŠØ§Ø±Ø§Øª Ø±Ø²ØŸ</label><input type="checkbox" checked={hasRiceSelection} onChange={e=>setHasRiceSelection(e.target.checked)}/></div>
                                    {hasRiceSelection && (
                                        <div className="mt-2 space-y-2">
                                            {riceTypes.map((r,i)=>(<div key={i} className="flex gap-1"><input value={r.name} onChange={e=>updateRiceName(i,e.target.value)} className="w-1/2 p-1 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"/><input type="number" step="any" value={r.price} onChange={e=>updateRicePrice(i,e.target.value)} className="w-1/4 p-1 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"/><button type="button" onClick={()=>removeRiceType(i)} className="text-red-500 hover:text-red-700">X</button></div>))}
                                            <button type="button" onClick={addRiceType} className="text-blue-600 dark:text-blue-400 text-sm">+ Ù†ÙˆØ¹</button>
                                        </div>
                                    )}
                                </div>
                                </>
                            )}
                            
                            <input name="image" defaultValue={currentItem?.image} placeholder="ØµÙˆØ±Ø©" className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded dir-ltr bg-white dark:bg-slate-700 dark:text-white"/>
                            <select name="status" defaultValue={currentItem?.status} className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 dark:text-white"><option value="Ù…ØªØ§Ø­">Ù…ØªØ§Ø­</option><option value="ØºÙŠØ± Ù…ØªØ§Ø­">ØºÙŠØ± Ù…ØªØ§Ø­</option></select>
                            <button className="w-full bg-orange-600 text-white py-3 rounded">Ø­ÙØ¸</button>
                        </form>
                    )}
                </div>
            </div>
        )}

        {/* --- Social Media Share Modal --- */}
        {selectedRating && (
            <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={() => setSelectedRating(null)}>
                <div className="relative bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl max-w-md w-full border border-slate-200 dark:border-slate-700" onClick={e => e.stopPropagation()}>
                    <button onClick={() => setSelectedRating(null)} className="absolute top-4 left-4 text-gray-500 hover:text-red-500 transition-colors"><X size={24}/></button>
                    <h3 className="text-center font-bold text-lg mb-4 text-slate-500 dark:text-slate-400 flex items-center justify-center gap-2"><Share2 size={18}/> Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©</h3>
                    <div id="shareableCard" className="bg-white p-8 rounded-xl shadow-lg relative overflow-hidden text-center border border-gray-100" style={{minHeight: '400px'}}>
                        <img src="images/logo red.png" className="absolute top-4 right-4 w-24 object-contain" alt="Samam Logo" />
                        <div className="flex flex-col items-center mt-8">
                            <div className="w-20 h-20 rounded-full border-4 border-orange-500 overflow-hidden mb-3 shadow-md bg-gray-100 flex items-center justify-center"><div className="w-full h-full bg-slate-200 flex items-center justify-center text-3xl font-bold text-slate-600">{(selectedRating.customerName || 'Ø¹Ù…ÙŠÙ„').charAt(0)}</div></div>
                            <h3 className="text-xl font-bold text-slate-800">{selectedRating.customerName || 'Ø¹Ù…ÙŠÙ„'}</h3><p className="text-sm text-slate-500 mb-6 flex items-center gap-1 justify-center">{getCustomerStatus(selectedRating, 'rating').label} <BadgeCheck size={14} className="text-blue-500"/></p> 
                            <div className="flex justify-center gap-1 mb-6">{[...Array(5)].map((_, i) => (<Star key={i} size={32} fill={i < (Number(selectedRating.rating) || 0) ? "#eab308" : "none"} strokeWidth={0} className={i < (Number(selectedRating.rating) || 0) ? "text-yellow-500" : "text-gray-300"} />))}</div>
                            <div className="relative z-10 mb-8 px-4 w-full"><span className="text-5xl text-orange-200 absolute -top-4 right-0 font-serif">"</span><p className="text-2xl font-bold text-slate-800 leading-relaxed font-cairo">{selectedRating.comment || "ØªØ¬Ø±Ø¨Ø© Ù…Ù…ÙŠØ²Ø©!"}</p><span className="text-5xl text-orange-200 absolute -bottom-8 left-0 font-serif">"</span></div>
                            <div className="mt-auto pt-4 border-t w-full border-gray-100 flex justify-between items-center"><span className="text-lg font-bold text-red-600">ØµÙ…Ù‘Ø§Ù… | SAMAM</span><span className="text-xs text-gray-400 dir-ltr font-mono">{new Date(selectedRating.createdAt?.seconds * 1000).toLocaleDateString('en-GB')}</span></div>
                        </div>
                    </div>
                    <div className="mt-6 text-center space-y-2"><button onClick={handleDownloadCard} disabled={downloading} className="w-full bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-colors disabled:opacity-50">{downloading ? (<Loader2 className="animate-spin" size={20} />) : (<Download size={20} />)}{downloading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²'}</button></div>
                </div>
            </div>
        )}
    </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>